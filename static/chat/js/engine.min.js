function chat(element,user,options){return this.server="ws://"+options.host+":"+options.port+"/ws",this.connected=!1,this.debug=!1,this.users=[],this.ignorelist={},this.controlevents=["MUTE","UNMUTE","BAN","UNBAN","SUBONLY"],this.errorstrings={nopermission:"You do not have the required permissions to use that",protocolerror:"Invalid or badly formatted",needlogin:"You have to be logged in to use that",invalidmsg:"The message was invalid",throttled:"Throttled! You were trying to send messages too fast",duplicate:"The message is identical to the last one you sent",muted:"You are muted",submode:"The channel is currently in subscriber only mode",needbanreason:"Providing a reason for the ban is mandatory",banned:"You have been banned, disconnecting",requiresocket:"This chat requires WebSockets",toomanyconnections:"Only 5 concurrent connections allowed",socketerror:"Error contacting server",notfound:"The user was not found"},this.user=new ChatUser(user),this.gui=new ChatGui(element,this,options),this.previousemote=null,this.originemote=null,this}!function(){var kCodes={TAB:9},mAutoComplete=function(input,options){return this.input=input,this.shards={},this.init(input,options)};mAutoComplete.prototype.getShardIdByTxt=function(txt){return txt.substr(0,1).toUpperCase()},mAutoComplete.prototype.addData=function(nick,weight){var id=this.getShardIdByTxt(nick);return this.shards[id]||(this.shards[id]={}),this.shards[id][nick]?this.shards[id][nick].weight=weight:this.shards[id][nick]={nick:nick,weight:weight},this},mAutoComplete.prototype.init=function(){return this.expireUsers=$.proxy(this.expireUsers,this),setInterval(this.expireUsers,3e5),this},mAutoComplete.prototype.getCaretWord=function(inp){var pre=inp.val().substring(0,inp[0].selectionStart),post=inp.val().substring(inp[0].selectionStart),startCaret=pre.lastIndexOf(" ")+1,endCaret=post.indexOf(" ");return startCaret>0&&(pre=pre.substring(startCaret)),endCaret>-1&&(post=post.substring(0,endCaret)),{pre:pre,post:post,word:pre+post,startIndex:startCaret}},mAutoComplete.prototype.cmp=function(a,b){if(a.weight==b.weight){var a=a.nick.toLowerCase(),b=b.nick.toLowerCase();return a==b?0:a>b?1:-1}return a.weight>b.weight?-1:1},mAutoComplete.prototype.search=function(txt){txt=txt.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&");var res=[],f=new RegExp("^"+txt,"i"),data=this.shards[this.getShardIdByTxt(txt)]||{};return $.each(data,function(nick,v){f.test(nick)&&res.push(v)}),res.sort(this.cmp),res},mAutoComplete.prototype.expireUsers=function(){var fiveminutesago=(new Date).getTime()-3e5;for(var i in this.shards)if(this.shards.hasOwnProperty(i))for(var j in this.shards[i])if(this.shards[i].hasOwnProperty(j)){var nick=this.shards[i][j];nick.weight>2&&nick.weight<fiveminutesago&&(nick.weight=1)}},$.fn.mAutoComplete=function(options){return this.each(function(){var settings=$.extend({minWordLength:3,maxResults:5,triggerKeys:[kCodes.TAB]},options),results=new Array,resultIndex=-1,searchWord="",originalTxt="",inp=$(this),autoComplete=new mAutoComplete(inp,options);if(inp.data("mAutoComplete",autoComplete),!inp[0].setSelectionRange)return this;var resetSearchResults=function(){results=[],resultIndex=-1,searchWord="",originalTxt=""},checkCurrentWord=function(){searchWord=autoComplete.getCaretWord(inp),searchWord.word.length<settings.minWordLength||(results=autoComplete.search(searchWord.word,settings.maxResults),originalTxt=inp.val())},showAutoComplete=function(){resultIndex=resultIndex>=results.length-1?0:resultIndex+1;var replace=(results[resultIndex]||{}).nick;if(replace){var pre=originalTxt.substr(0,searchWord.startIndex),post=originalTxt.substr(searchWord.startIndex+searchWord.word.length);(" "!=post.substring(0,1)||0==post.length)&&(post=" "+post),replace.toLowerCase()!=searchWord.word.toLowerCase()&&(inp.focus(),(" "!=post.substring(0,1)||0==post.length)&&(replace+=" "),inp.val(pre+replace+post),""==post.trim()?inp.blur().focus():inp[0].setSelectionRange(pre.length+replace.length,pre.length+replace.length))}};inp.on({mousedown:function(){return resetSearchResults(),!0},keydown:function(e){return $.inArray(e.keyCode,settings.triggerKeys)>=0?(results.length<=0&&(resetSearchResults(),checkCurrentWord()),showAutoComplete(),!1):(resetSearchResults(),!0)}})})}}(),function(w){"use strict";if(w.requestAnimationFrame=w.requestAnimationFrame||w.mozRequestAnimationFrame||w.webkitRequestAnimationFrame||w.msRequestAnimationFrame,w.cancelAnimationFrame=w.cancelAnimationFrame||w.mozCancelAnimationFrame||w.webkitCancelAnimationFrame||w.msCancelAnimationFrame,!w.requestAnimationFrame){var iIntervalId,aAnimQueue=[],iRequestId=0;w.requestAnimationFrameLegacy=function(callback){return aAnimQueue.push([++iRequestId,callback]),iIntervalId||(iIntervalId=setInterval(function(){aAnimQueue.length?aAnimQueue.shift()[1](+new Date):(clearInterval(iIntervalId),iIntervalId=void 0)},20)),iRequestId},w.cancelAnimationFrameLegacy=function(requestId){for(var i=0,j=aAnimQueue.length;j>i;i+=1)if(aAnimQueue[i][0]===requestId)return aAnimQueue.splice(i,1),void 0}}}(window),function($){destiny.fn.mCustomScrollbarPlugin=function(chat){return this.chat=chat,this.init()},$.extend(destiny.fn.mCustomScrollbarPlugin.prototype,{scrolledBottom:!0,scrollLocked:!0,chat:null,update:function(){this.chat.output.mCustomScrollbar("update")},init:function(){var self=this;return self.chat.output.mCustomScrollbar({theme:"light-thin",scrollInertia:0,horizontalScroll:!1,autoHideScrollbar:!1,scrollButtons:{enable:!0},callbacks:{onTotalScrollOffset:20,onTotalScrollBackOffset:20,onScrollStart:function(){self.scrolledBottom=!1},onTotalScrollBack:function(){self.scrolledBottom=!1},onTotalScroll:function(){self.scrolledBottom=!0}}}),self.chat.ui.addClass("chat-custom-scroll"),!0},lockScroll:function(lock){return this.scrollLocked=lock,this},scrollBottom:function(){return this.scrolledBottom=!0,this.chat.output.mCustomScrollbar("scrollTo","bottom")},isScrolledBottom:function(){return!this.isScrollable()||this.scrolledBottom},isScrollable:function(){return this.chat.output.height()<this.chat.lines.height()},isScrollLocked:function(){return this.scrollLocked},scroll:function(to){var moveAmt=Math.floor(this.chat.output.height()/3),pos=Math.abs(this.chat.lines.parent().position().top);return"up"==to?this.chat.output.mCustomScrollbar("scrollTo",pos-moveAmt):"down"==to?this.chat.output.mCustomScrollbar("scrollTo",pos+moveAmt):this.chat.output.mCustomScrollbar("scrollTo",to)}})}(jQuery),function(){cMenu=function(){return this};var showMenuUI=function(ui){clearTimeout(ui.data("hide-timeout")),ui.addClass("active").css("visibility","visible")},hideMenuUI=function(ui){ui.removeClass("active"),ui.data("hide-timeout",setTimeout(function(){ui.css("visibility","hidden")},250))};cMenu.addMenu=function(chat,e){return e.on("click",".close",function(){return cMenu.closeMenus(chat),!1}),cMenu.prototype.scrollable.apply(e),chat.menus.push(e),this},cMenu.closeMenus=function(chat){for(var i=0;i<chat.menus.length;++i)chat.menus[i].visible&&this.prototype.hideMenu.call(chat.menus[i],chat)},cMenu.prototype.showMenu=function(chat){showMenuUI(this),this.visible=!0,this.btn.addClass("active"),this.scrollable.mCustomScrollbar("update"),++chat.menuOpenCount},cMenu.prototype.hideMenu=function(chat){hideMenuUI(this),this.visible=!1,this.btn.removeClass("active"),--chat.menuOpenCount},cMenu.prototype.scrollable=function(){this.scrollable.mCustomScrollbar({theme:"light-thin",scrollInertia:0,horizontalScroll:!1,autoHideScrollbar:!0,scrollButtons:{enable:!1}})},cUserTools=function(chat){var self=this;return this.chat=chat,this.visible=!1,this.label="",this.user=null,this.username="",this.ui=chat.ui.find(".user-tools"),this.ui.user=this.ui.find(".user-tools-user"),this.ui.muteForm=this.ui.find("#user-mute-form"),this.ui.muteForm.on("submit",function(){var time=$(this).find("#banTimeLength");return chat.engine.handleCommand("mute "+self.username+" "+time.val()+"m"),time.val("0"),self.hide(),!1}),this.ui.banForm=this.ui.find("#user-ban-form"),this.ui.banForm.on("submit",function(){var time=$(this).find("#banTimeLength"),reason=$(this).find("#banReason"),ipBan=$(this).find("#ipBan"),cmd="1"==ipBan.val()?"ipban":"ban";return chat.engine.handleCommand(cmd+" "+self.username+" "+time.val()+"m "+htmlEncode(reason.val())),time.val("0"),reason.val(""),ipBan.val(""),self.hide(),!1}),this.ui.on("click","a#ignoreuser,a#unignoreuser",function(){var cmd=$(this).attr("href").substring(1);return chat.engine.handleCommand(cmd+" "+self.username),self.hide(),self.show(self.label,self.username,self.user),!1}),this.ui.on("click","a#clearmessages",function(){return chat.engine.handleCommand("mute "+self.username+" 1ms"),self.hide(),!1}),this.ui.on("click","a.close",$.proxy(this.hide,this)),this},cUserTools.prototype.hide=function(){return this.visible?(this.chat.lines.find(".focused").removeClass("focused"),this.chat.ui.removeClass("focus-user"),this.ui.removeClass("user-ignored"),hideMenuUI(this.ui),this.visible=!1,$(this).triggerHandler("hide"),!1):void 0},cUserTools.prototype.show=function(label,username,user){return this.visible&&username==this.username?this.hide():(this.visible&&this.hide(),this.ui.muteForm.hide(),this.ui.banForm.hide(),this.label=label,this.user=user,this.username=username,this.chat.engine.ignorelist[this.username]&&this.ui.addClass("user-ignored"),this.ui.user.text(this.label),this.chat.lines.find('div[data-username="'+this.username+'"]').addClass("focused"),this.chat.ui.addClass("focus-user"),showMenuUI(this.ui),this.visible=!0,$(this).triggerHandler("show"),!1)}}(),function(){destiny.fn.EmoteFormatter=function(chat){return this.emoteregex=new RegExp("(^|\\s)("+chat.emoticons.join("|")+")($|\\s)"),this.gemoteregex=new RegExp("(^|\\s)("+chat.emoticons.join("|")+")($|\\s)","gm"),this},destiny.fn.EmoteFormatter.prototype.format=function(str,user){var emoteregex=user&&(user.features||[]).length>0?this.gemoteregex:this.emoteregex;return str.replace(emoteregex,'$1<div title="$2" class="chat-emote chat-emote-$2"></div>$3')},destiny.fn.UrlFormatter=function(){var chars_reg="[\\w!\"#$%&'*+,-./:;<=>?@\\\\^`|~]*",path_reg="(?:"+chars_reg+"(?:\\("+chars_reg+"\\))?(?:\\["+chars_reg+"\\])?(?:\\{"+chars_reg+"\\})?)*",tlds="(?:MUSEUM|TRAVEL|AERO|ARPA|ASIA|COOP|INFO|JOBS|MOBI|NAME|POST|BIZ|CAT|COM|EDU|GOV|INT|MIL|NET|ORG|PRO|TEL|XXX|AC|AD|AE|AF|AG|AI|AL|AM|AN|AO|AQ|AR|AS|AT|AU|AW|AX|AZ|BA|BB|BD|BE|BF|BG|BH|BI|BJ|BM|BN|BO|BR|BS|BT|BV|BW|BY|BZ|CA|CC|CD|CF|CG|CH|CI|CK|CL|CM|CN|CO|CR|CU|CV|CW|CX|CY|CZ|DE|DJ|DK|DM|DO|DZ|EC|EE|EG|ER|ES|ET|EU|FI|FJ|FK|FM|FO|FR|GA|GB|GD|GE|GF|GG|GH|GI|GL|GM|GN|GP|GQ|GR|GS|GT|GU|GW|GY|HK|HM|HN|HR|HT|HU|ID|IE|IL|IM|IN|IO|IQ|IR|IS|IT|JE|JM|JO|JP|KE|KG|KH|KI|KM|KN|KP|KR|KW|KY|KZ|LA|LB|LC|LI|LK|LR|LS|LT|LU|LV|LY|MA|MC|MD|ME|MG|MH|MK|ML|MM|MN|MO|MP|MQ|MR|MS|MT|MU|MV|MW|MX|MY|MZ|NA|NC|NE|NF|NG|NI|NL|NO|NP|NR|NU|NZ|OM|PA|PE|PF|PG|PH|PK|PL|PM|PN|PR|PS|PT|PW|PY|QA|RE|RO|RS|RU|RW|SA|SB|SC|SD|SE|SG|SH|SI|SJ|SK|SL|SM|SN|SO|SR|ST|SU|SV|SX|SY|SZ|TC|TD|TF|TG|TH|TJ|TK|TL|TM|TN|TO|TP|TR|TT|TV|TW|TZ|UA|UG|UK|US|UY|UZ|VA|VC|VE|VG|VI|VN|VU|WF|WS|YE|YT|ZA|ZM|ZW)",ipaddr="(?:(?:25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])\\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])";return this.linkregex=new RegExp("(((?:https?|ftp):\\/\\/)?(?:[\\w]+(?::"+chars_reg+")?@)?(?:"+ipaddr+"|(?:(?:[\\w-]+\\.)+"+tlds+"))(?::[0-9]{1,5})?(?:\\/"+path_reg+")?)","gi"),this},destiny.fn.UrlFormatter.prototype.encodeUrl=function(url){return url.replace(/["']/g,function(c){var htmlencmap={"'":"&#39;",'"':"&quot;"};return htmlencmap[c]})},destiny.fn.UrlFormatter.prototype.format=function(str){var nsfw=/\b(?:NSFW|NSFL|SPOILER)\b/i.test(str),css=[],formatter=this;return css.push("externallink"),nsfw&&css.push("nsfw-link"),str.replace(this.linkregex,function(match,url,scheme){scheme=scheme?"":"http://";var encodedUrl=formatter.encodeUrl(url);return match.replace(url,'<a target="_blank" class="'+css.join(" ")+'" href="'+scheme+encodedUrl+'" rel="nofollow">'+encodedUrl+"</a>")})}}(jQuery),function(){localStorage||(localStorage={}),hintPopup=function(chat){this.hints={slashhelp:"Type in /help for more advanced features, like modifying the scrollback size",tabcompletion:"Use the tab key to auto-complete usernames and emotes",hoveremotes:"Hovering your mouse over an emote will show you the emote code",highlight:"Chat messages containing your username will be highlighted in blue",ignoreuser:"Ignore other users by clicking their name and selecting ignore",moreinfo:'See the <a href="/chat/faq" target="_blank">chat FAQ</a> for more information',emotewiki:'For the list of available emotes type /emotes or <a href="https://github.com/destinygg/website/wiki/Emotes" target="_blank">click here</a>',mutespermanent:"Mutes are never persistent, don't worry it will pass!"},this.popupInterval=36e5,this.readingInterval=3e4,this.paused=!1,this.visible=!1,this.enabled=!0,this.hiddenhints=JSON.parse(localStorage.hiddenhints||"[]"),this.lasthinttime=localStorage.lasthinttime||null,this.currenthint="",this.hintindex=[];for(var i in this.hints)this.hintindex.push(i);this.ui=chat.ui.find(".hint-popup"),this.ui.hintmessage=this.ui.find(".hint-message"),this.ui.on("click",".hidehint",$.proxy(this.hideHint,this)),this.ui.on("click",".nexthint",$.proxy(this.nextHint,this)),this.enabled&&this.listenForInput(chat)},hintPopup.prototype.listenForInput=function(chat){chat.input.unbind(".hintpopup"),chat.input.on("click.hintpopup keydown.hintpopup",$.proxy(function(e){chat.loaded&&116!=e.keyCode&&(chat.input.unbind(".hintpopup"),this.invoke())},this))},hintPopup.prototype.invoke=function(){return this.visible||!this.enabled?!1:!this.lasthinttime||(new Date).getTime()-this.lasthinttime>=this.popupInterval?(this.currenthint=this.getRandomHint(),this.currenthint?(this.show(),!0):!1):!1},hintPopup.prototype.enable=function(enabled){this.enabled=enabled},hintPopup.prototype.reset=function(chat){this.hiddenhints=[],this.updateHiddenHints(),this.updateLastHintTime(0),this.listenForInput(chat)},hintPopup.prototype.getRandomHint=function(){for(var hint=null,i=0;++i;){var id=this.hintindex[Math.floor(Math.random()*this.hintindex.length)];if(-1==this.hiddenhints.indexOf(id)&&(hint=id),i==this.hintindex.length||hint)break}return hint},hintPopup.prototype.hideHint=function(){return this.hiddenhints.push(this.currenthint),this.updateHiddenHints(),this.hide(),!1},hintPopup.prototype.nextHint=function(){return this.currenthint?(this.currenthint=this.hintindex[this.hintindex.indexOf(this.currenthint)+1]||this.hintindex[0],this.hiddenhints.push(this.currenthint),this.updateHiddenHints(),this.show(),!1):void 0},hintPopup.prototype.show=function(){clearTimeout(this.ui.data("hide-timeout")),clearTimeout(this.hideTimeoutId),this.hideTimeoutId=setTimeout($.proxy(this.hide,this),this.readingInterval),this.ui.hintmessage.html(this.hints[this.currenthint]),this.updateLastHintTime((new Date).getTime()),this.ui.addClass("active").css("visibility","visible"),this.visible=!0},hintPopup.prototype.hide=function(){clearTimeout(this.ui.data("hide-timeout")),clearTimeout(this.hideTimeoutId),this.currenthint="",this.visible=!1,this.ui.removeClass("active").data("hide-timeout",setTimeout($.proxy(function(){this.ui.css("visibility","hidden")},this),250))},hintPopup.prototype.updateHiddenHints=function(){localStorage.hiddenhints=JSON.stringify(this.hiddenhints)},hintPopup.prototype.updateLastHintTime=function(time){this.lasthinttime=time,localStorage.lasthinttime=this.lasthinttime}}(),function($){destiny.chat,$.fn.ChatGui=function(user,options){destiny.chat=new chat(this,user,options),destiny.chat.start()},ChatGui=function(element,engine,options){return this.ui=$(element),this.engine=engine,$.extend(this,options),this.init()},$.extend(ChatGui.prototype,{theme:"dark",maxlines:500,lineCount:0,scrollPlugin:null,autoCompletePlugin:null,ui:null,lines:null,output:null,input:null,onSend:$.noop,userMessages:[],backlog:backlog,highlightregex:{},highlightnicks:{},notifications:!0,lastMessage:null,menus:[],menuOpenCount:0,timestampformat:null,emoticons:[],formatters:[],hintPopup:null,loaded:!1,init:function(){var chat=this;this.lines=this.ui.find(".chat-lines:first").eq(0),this.output=this.ui.find(".chat-output:first").eq(0),this.inputwrap=this.ui.find(".chat-input:first").eq(0),this.input=this.inputwrap.find(".input:first").eq(0),this.inputwrap.removeClass("hidden"),this.formatters.push(new destiny.fn.EmoteFormatter(this)),this.formatters.push(new destiny.fn.UrlFormatter(this)),this.scrollPlugin=new destiny.fn.mCustomScrollbarPlugin(this),this.scrollPlugin.lockScroll(!0),this.currenthistoryline=-1,this.storedinputline=null,window.localStorage&&this.setupInputHistory(),this.setupNotifications(),this.engine.user.username&&(this.highlightregex.user=new RegExp("\\b"+this.engine.user.username+"\\b","i")),this.autoCompletePlugin=this.input.mAutoComplete({minWordLength:2,maxResults:10}).data("mAutoComplete");for(var i=this.emoticons.length-1;i>=0;i--)this.autoCompletePlugin.addData(this.emoticons[i],2);return this.chatsettings=this.ui.find("#chat-settings:first").eq(0),this.chatsettings.btn=this.ui.find(".chat-settings-btn:first").eq(0),this.chatsettings.list=this.chatsettings.find("ul:first").eq(0),this.chatsettings.visible=!1,this.chatsettings.scrollable=this.chatsettings.find(".scrollable:first"),this.loadSettings(),this.chatsettings.btn.on("click",function(e){return e.preventDefault(),chat.chatsettings.visible?cMenu.prototype.hideMenu.call(chat.chatsettings,chat):(cMenu.closeMenus(chat),cMenu.prototype.showMenu.call(chat.chatsettings,chat))}),this.chatsettings.on("keypress blur","input[name=customhighlight]",function(e){var keycode=e.keyCode?e.keyCode:e.which;if(!keycode||13==keycode){e.preventDefault();for(var data=$(this).val().trim().split(","),i=data.length-1;i>=0;i--)data[i]=data[i].trim(),data[i]||data.splice(i,1);chat.saveChatOption("customhighlight",data),chat.loadCustomHighlights()}}),this.chatsettings.on("change",'input[type="checkbox"]',function(){var name=$(this).attr("name"),checked=$(this).is(":checked");switch(name){case"showtime":chat.saveChatOption(name,checked),chat.ui.toggleClass("chat-time",checked),chat.resize();break;case"hideflairicons":chat.saveChatOption(name,checked),chat.ui.toggleClass("chat-icons",!checked),chat.resize();break;case"highlight":chat.saveChatOption(name,checked);break;case"notifications":if(!notifications)break;var permission;if(notifications.checkPermission)permission=notifications.checkPermission();else if(notifications.permission)switch(notifications.permission){case"default":permission=1;break;case"denied":permission=2;break;case"granted":permission=3}if(1==permission)notifications.requestPermission(function(){});else if(2==permission){chat.notifications=!1;break}chat.notifications=checked,chat.saveChatOption(name,checked)}}),this.userslist=this.ui.find("#chat-user-list:first").eq(0),this.userslist.btn=this.ui.find(".chat-users-btn:first").eq(0),this.userslist.visible=!1,this.userslist.scrollable=this.userslist.find(".scrollable:first"),this.userslist.btn.on("click",function(e){if(e.preventDefault(),chat.userslist.visible)return cMenu.prototype.hideMenu.call(chat.userslist,chat);cMenu.closeMenus(chat);var lists=chat.userslist.find("ul"),admins=[],vips=[],mods=[],bots=[],subs=[],plebs=[],elems={},usercount=0;for(var username in chat.engine.users){var u=chat.engine.users[username],elem=$('<li><a class="user '+u.features.join(" ")+'">'+u.username+"</a></li>");usercount++,elems[username.toLowerCase()]=elem,$.inArray("bot",u.features)>=0?bots.push(username.toLowerCase()):$.inArray("admin",u.features)>=0?admins.push(username.toLowerCase()):$.inArray("vip",u.features)>=0?vips.push(username.toLowerCase()):$.inArray("moderator",u.features)>=0?mods.push(username.toLowerCase()):$.inArray("subscriber",u.features)>=0?subs.push(username.toLowerCase()):plebs.push(username.toLowerCase())}chat.userslist.find("h5 span").text(usercount);var appendUsers=function(users,elem){if(0==users.length)return elem.prev().hide().prev().hide(),void 0;elem.prev().show().prev().show(),users.sort();for(var i=0;i<users.length;i++)elem.append(elems[users[i]])};return lists.empty(),appendUsers(admins,lists.filter(".admins")),appendUsers(vips,lists.filter(".vips")),appendUsers(mods,lists.filter(".moderators")),appendUsers(bots,lists.filter(".bots")),appendUsers(subs,lists.filter(".subs")),appendUsers(plebs,lists.filter(".plebs")),cMenu.prototype.showMenu.call(chat.userslist,chat)}),cMenu.addMenu(this,this.chatsettings),cMenu.addMenu(this,this.userslist),this.cUserTools=new cUserTools(this),this.userslist.on("click",".user",function(){var username=$(this).text().toLowerCase();chat.cUserTools.show($(this).text(),username,chat.engine.users[username])}),this.lines.on("mousedown","div.user-msg a.user",function(){var username=$(this).closest(".user-msg").data("username");return chat.cUserTools.show($(this).text(),username,chat.engine.users[username]),!1}),this.hintPopup=new hintPopup(this),this.chatsettings.find("#resethints").on("click",$.proxy(function(e){e.preventDefault(),this.reset(chat)},this.hintPopup)),$(chat.cUserTools).on("show",$.proxy(function(){this.hide()},this.hintPopup)),this.ui.on("submit","form.chat-input",function(e){e.preventDefault(),chat.send()}),this.ui.on("click",".chat-send-btn",function(e){e.preventDefault(),chat.send()}),this.input.on("keydown mousedown",$.proxy(function(e){return this.menuOpenCount>0&&cMenu.closeMenus(this),33==e.keyCode?(this.scrollPlugin.scroll("up"),!1):34==e.keyCode?(this.scrollPlugin.scroll("down"),!1):void 0},this)),this.output.on("mousedown",$.proxy(function(){this.cUserTools.visible&&this.cUserTools.hide(),this.menuOpenCount>0&&cMenu.closeMenus(this)},this)),this.ui.find(".chat-tools-wrap button").removeAttr("disabled"),this.resize()},loadSettings:function(){var self=this,defaults={showtime:!1,hideflairicons:!1,highlight:!0,notifications:!1,maxlines:this.maxlines,timestampformat:"HH:mm"};this.timestampformat=self.getChatOption("timestampformat",defaults.timestampformat),this.maxlines=self.getChatOption("maxlines",defaults.maxlines),customhighlight=self.getChatOption("customhighlight",[]),this.chatsettings.find("input[name=customhighlight]").val(customhighlight.join(", ")),this.loadCustomHighlights(),this.chatsettings.find('input[type="checkbox"]').each(function(){var name=$(this).attr("name"),value=self.getChatOption(name,defaults[name]);switch($(this).attr("checked",value),name){case"showtime":self.ui.toggleClass("chat-time",value),self.resize();break;case"hideflairicons":self.ui.toggleClass("chat-icons",!value),self.resize()}})},loadBacklog:function(){if(this.backlog.length>0){for(var i=this.backlog.length-1;i>=0;i--){var line=this.backlog[i],message=this.engine.dispatchBacklog(line);if(message)if($.inArray(line.event,this.engine.controlevents)>=0)this.put(message);else{var m=this.put(message);this.handleHighlight(m,!0)}}this.put(new ChatUIMessage("<hr/>")),this.scrollPlugin.update()}},lineCount:function(){return this.lines.children().length},push:function(message,state){var isScrolledBottom=this.scrollPlugin.isScrolledBottom();return this.userMessages.push(message),this.put(message,state),this.scrollPlugin.update(),isScrolledBottom&&this.scrollPlugin.isScrollLocked()&&(this.lineCount()>=this.maxlines&&(this.lines.children().slice(0,2+Math.floor((this.lineCount()-this.maxlines)/this.maxlines*100)).remove(),this.recalculateDimensions(),this.scrollPlugin.update()),this.scrollPlugin.scrollBottom()),this.handleHighlight(message),message},put:function(message,state){return message instanceof ChatUserMessage?(message.ui=this.lastMessage&&this.lastMessage.user&&message.user&&this.lastMessage.user.username==message.user.username?$(message.addonHtml()):$(message.html()),message.user&&this.engine.user&&this.engine.user.username==message.user.username&&message.ui.addClass("own-msg")):message.ui=$(message.html()),message.ui.appendTo(this.lines),void 0!=state&&message.status(state),this.lastMessage=message,message},send:function(){var str=this.input.val().trim();return""!=str&&(this.input.val("").focus(),this.onSend(str,this.input[0]),this.insertInputHistory(str),this.currenthistoryline=-1),str=null,this},recalculateDimensions:function(){this.output.height(this.ui.height()-(this.inputwrap.height()+parseInt(this.inputwrap.css("margin-top"))))},resize:function(){this.recalculateDimensions();var isScrolledBottom=this.scrollPlugin.isScrolledBottom();return this.scrollPlugin.update(),isScrolledBottom&&this.scrollPlugin.isScrollLocked()&&this.scrollPlugin.scrollBottom(),this},setupInputHistory:function(){var modifierpressed=!1,chat=this;$(this.input).on("keyup",function(e){if((e.shiftKey||e.metaKey||e.ctrlKey)&&(modifierpressed=!0),38!=e.keyCode&&40!=e.keyCode||modifierpressed)return modifierpressed=!1,void 0;var num=38==e.keyCode?-1:1;if(chat.currenthistoryline<0&&38==e.keyCode){if(chat.currenthistoryline=chat.getInputHistory().length,chat.storedinputline=chat.input.val(),chat.currenthistoryline<=0)return}else if(chat.currenthistoryline<0&&40==e.keyCode)return;var index=chat.currenthistoryline+num;return index>=chat.getInputHistory().length||0>index?(index>=chat.getInputHistory().length&&(chat.input.val(chat.storedinputline),chat.currenthistoryline=-1),void 0):(chat.currenthistoryline=index,chat.input.val(chat.getInputHistory()[index]),void 0)})},getInputHistory:function(){return JSON.parse(localStorage.inputhistory||"[]")},setInputHistory:function(arr){localStorage.inputhistory=JSON.stringify(arr)},insertInputHistory:function(message){if(window.localStorage){var history=this.getInputHistory();history.push(message),history.length>20&&history.shift(),this.setInputHistory(history)}},resolveMessage:function(data){for(var i in this.userMessages)if(this.userMessages[i].message==data.data){var message=this.userMessages[i];return message.status(),this.userMessages[i]=null,delete this.userMessages[i],message}return null},setupNotifications:function(){window.notifications=window.webkitNotifications||window.mozNotifications||window.oNotifications||window.msNotifications||window.notifications||window.Notification,notifications||$("#chat-settings input[name=notifications]").closest("label").text("Notifications are not supported by your browser"),notifications&&this.engine.user.username&&this.getChatOption("notifications",!1)||(this.notifications=!1)},showNotification:function(message){if(this.notifications){var msg=message.message,title=message.user?""+message.user.username+" said ...":"Highlight ...",notif=null,self=this;msg.length>=30&&(msg=msg.substring(0,30)+"..."),this.currentnotification&&this.currentnotification.close(),notifications.createNotification?(notif=notifications.createNotification(destiny.cdn+"/chat/img/notifyicon.png",title,msg),this.currentnotification=notif,notif.show()):(notif=new notifications(title,{icon:destiny.cdn+"/chat/img/notifyicon.png",body:msg,tag:message.timestamp.unix(),dir:"auto"}),this.currentnotification=notif),setTimeout(function(){notif.close(),notif===self.currentnotification&&(self.currentnotification=null),self=null},5e3)}},loadCustomHighlights:function(){this.highlightnicks=this.getChatOption("highlightnicks",{});var highlights=this.getChatOption("customhighlight",[]);if(0!=highlights.length){for(var i=highlights.length-1;i>=0;i--)highlights[i]=highlights[i].replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&");this.highlightregex.custom=new RegExp("\\b(?:"+highlights.join("|")+")\\b","i")}},handleHighlight:function(message,skipnotify){if(message.user&&message.user.username!=this.engine.user.username){var u=message.user.username.toLowerCase();this.highlightnicks[u]&&message.ui.addClass("highlight"),this.highlightregex.user&&this.getChatOption("highlight",!0)&&(this.highlightregex.user.test(message.message)||this.highlightregex.custom&&this.highlightregex.custom.test(message.message))&&(message.ui.addClass("highlight"),!skipnotify&&this.notifications&&this.showNotification(message))}},getChatOption:function(option,defaultvalue){var options=JSON.parse(localStorage.chatoptions||"{}");return void 0==options[option]?defaultvalue:options[option]},saveChatOption:function(option,value){var options=JSON.parse(localStorage.chatoptions||"{}");options[option]=value,localStorage.chatoptions=JSON.stringify(options)},removeUserMessages:function(username){this.lines.children('div[data-username="'+username.toLowerCase()+'"]').remove(),this.resize()}}),$(window).on({"resize.chat":function(){destiny.chat.gui.resize()},"focus.chat":function(){destiny.chat.gui.input.focus()},"load.chat":function(){destiny.chat.gui.input.focus(),destiny.chat.gui.loaded=!0}}),UserFeatures={PROTECTED:"protected",SUBSCRIBER:"subscriber",SUBSCRIBERT2:"flair1",SUBSCRIBERT3:"flair3",VIP:"vip",MODERATOR:"moderator",ADMIN:"admin",BOT:"bot",NOTABLE:"flair2"},ChatUser=function(args){return args=args||{},this.username=args.nick||"",this.connections=0,this.features=[],$.extend(this,args),this},ChatUser.prototype.getFeatureHTML=function(){for(var icons="",i=0;i<this.features.length;i++)switch(this.features[i]){case UserFeatures.VIP:icons+='<i class="icon-vip" title="VIP"/>';break;case UserFeatures.MODERATOR:icons+='<i class="icon-moderator" title="Moderator"/>';break;case UserFeatures.ADMIN:icons+='<i class="icon-administrator" title="Administrator"/>';break;case UserFeatures.BOT:icons+='<i class="icon-bot" title="Bot"/>';break;case UserFeatures.NOTABLE:icons+='<i class="icon-notable" title="Notable"/>'}return $.inArray(UserFeatures.SUBSCRIBERT3,this.features)>=0?icons+='<i class="icon-subscribert3" title="Subscriber (T3)"/>':$.inArray(UserFeatures.SUBSCRIBERT2,this.features)>=0?icons+='<i class="icon-subscribert2" title="Subscriber (T2)"/>':$.inArray(UserFeatures.SUBSCRIBER,this.features)>=0&&(icons+='<i class="icon-subscriber" title="Subscriber (T1)"/>'),icons},ChatUIMessage=function(html){return this.init(html)},ChatUIMessage.prototype.init=function(html){return this.message=html,this},ChatUIMessage.prototype.html=function(){return this.wrap(this.wrapMessage())},ChatUIMessage.prototype.wrap=function(html){return'<div class="ui-msg">'+html+"</div>"},ChatUIMessage.prototype.wrapMessage=function(){return this.message},ChatMessage=function(message,timestamp){return this.init(message,timestamp)},ChatMessage.prototype.init=function(message,timestamp){return this.message=message,this.timestamp=moment.utc(timestamp).local(),this.state=null,this.type="chat",this.timestampformat=destiny.chat.gui.timestampformat,this},ChatMessage.prototype.status=function(state){return this.ui&&(state?this.ui.addClass(state):this.ui.removeClass(this.state)),this.state=state,this},ChatMessage.prototype.wrapTime=function(){return'<time title="'+this.timestamp.format("MMMM Do YYYY, h:mm:ss a")+'" datetime="'+this.timestamp.format("MMMM Do YYYY, h:mm:ss a")+'">'+this.timestamp.format(this.timestampformat)+"</time>"},ChatMessage.prototype.wrapMessage=function(){return $("<span/>").text(this.message).html()},ChatMessage.prototype.html=function(){return this.wrap(this.wrapTime()+" "+this.wrapMessage())},ChatMessage.prototype.wrap=function(content){return'<div class="'+this.type+'-msg">'+content+"</div>"},ChatErrorMessage=function(error,timestamp){return this.init(error,timestamp),this.type="error",this},$.extend(ChatErrorMessage.prototype,ChatMessage.prototype),ChatErrorMessage.prototype.html=function(){return this.wrap(this.wrapTime()+' <i class="icon-error"></i> '+this.wrapMessage())},ChatInfoMessage=function(message,timestamp){return this.init(message,timestamp),this.type="info",this},$.extend(ChatInfoMessage.prototype,ChatMessage.prototype),ChatInfoMessage.prototype.html=function(){return this.wrap(this.wrapTime()+' <i class="icon-info"></i> '+this.wrapMessage())},ChatCommandMessage=function(message,timestamp){return this.init(message,timestamp),this.type="command",this},$.extend(ChatCommandMessage.prototype,ChatMessage.prototype),ChatCommandMessage.prototype.html=function(){return this.wrap(this.wrapTime()+' <i class="icon-command"></i> '+this.wrapMessage())
},ChatStatusMessage=function(message,timestamp){return this.init(message,timestamp),this.type="status",this},$.extend(ChatStatusMessage.prototype,ChatMessage.prototype),ChatStatusMessage.prototype.html=function(){return this.wrap(this.wrapTime()+' <i class="icon-status"></i> '+this.wrapMessage())},ChatBroadcastMessage=function(message,timestamp){return this.init(message,timestamp),this.type="broadcast",this},$.extend(ChatBroadcastMessage.prototype,ChatMessage.prototype),ChatBroadcastMessage.prototype.html=function(){return this.wrap(this.wrapTime()+" "+this.wrapMessage())},ChatBroadcastMessage.prototype.wrapMessage=function(){for(var elem=$("<msg/>").text(this.message),encoded=elem.html(),i=0;i<destiny.chat.gui.formatters.length;++i)encoded=destiny.chat.gui.formatters[i].format(encoded);return elem.html(encoded),elem.get(0).outerHTML},ChatUserMessage=function(message,user,timestamp){return this.init(message,timestamp),this.type="user",this.isEmote=!1,"/me "===this.message.substring(0,4)?(this.isEmote=!0,this.message=this.message.substring(4)):"//"===this.message.substring(0,2)&&(this.message=this.message.substring(1)),this.isAddon=!1,this.user=user,this},$.extend(ChatUserMessage.prototype,ChatMessage.prototype),ChatUserMessage.prototype.wrap=function(html,css){return this.user&&this.user.username?'<div class="'+this.type+"-msg"+(css?" "+css:"")+'" data-username="'+this.user.username.toLowerCase()+'">'+html+"</div>":'<div class="'+this.type+"-msg"+(css?" "+css:"")+'">'+html+"</div>"},ChatUserMessage.prototype.wrapUser=function(user){return(this.isEmote?"":user.getFeatureHTML())+' <a class="user '+user.features.join(" ")+'">'+user.username+"</a>"},ChatUserMessage.prototype.wrapMessage=function(){var elem=$("<msg/>").text(this.message),encoded=elem.html();this.isEmote&&elem.addClass("emote");for(var i=0;i<destiny.chat.gui.formatters.length;++i)encoded=destiny.chat.gui.formatters[i].format(encoded,this.user);return elem.html(encoded),elem.get(0).outerHTML},ChatUserMessage.prototype.html=function(){return this.wrap(this.wrapTime()+" "+(this.isEmote?"*":"")+this.wrapUser(this.user)+(this.isEmote?" ":": ")+this.wrapMessage())},ChatUserMessage.prototype.addonHtml=function(){return this.isEmote?this.wrap(this.wrapTime()+" *"+this.wrapUser(this.user)+" "+this.wrapMessage()):this.wrap(this.wrapTime()+' <span class="continue">&gt;</span> '+this.wrapMessage(),"continue")},ChatEmoteMessage=function(emote,timestamp){return this.init(emote,timestamp),this.emotecount=1,this},$.extend(ChatEmoteMessage.prototype,ChatMessage.prototype),ChatEmoteMessage.prototype.getEmoteCountLabel=function(){return"C-C-C-COMBO: "+this.emotecount+"x"},ChatEmoteMessage.prototype.html=function(){return this.wrap(this.wrapTime()+" "+this.wrapMessage()+'<span class="emotecount">'+this.getEmoteCountLabel()+"<span>")},ChatEmoteMessage.prototype.wrapMessage=function(){for(var elem=$("<msg/>").text(this.message),encoded=elem.html(),i=0;i<destiny.chat.gui.formatters.length;++i)encoded=destiny.chat.gui.formatters[i].format(encoded);return elem.html(encoded),elem.get(0).outerHTML},ChatEmoteMessage.prototype.incEmoteCount=function(){++this.emotecount,this.ui.find(".emotecount").detach().text(this.getEmoteCountLabel()).appendTo(this.ui)}}(jQuery),chat.prototype.start=function(){return window.MozWebSocket&&(window.WebSocket=MozWebSocket),window.WebSocket?(this.gui.onSend=function(str){if(null==this.engine.user||!this.engine.user.username)return this.push(new ChatErrorMessage(this.engine.errorstrings.requiresocket));if("/me "===str.substring(0,4))var message=str.substring(4);else var message=str;return-1!=$.inArray(message,this.emoticons)&&this.engine.previousemote&&this.engine.previousemote.message==message?this.engine.emit("MSG",{data:str}):"/"===str.substring(0,1)?this.engine.handleCommand(str.substring(1)):(this.push(new ChatUserMessage(str,this.engine.user),this.engine.connected?"pending":"unsent"),this.engine.emit("MSG",{data:str}),void 0)},this.gui.loadBacklog(),this.loadIgnoreList(),this.dispatchBacklog=$.proxy(this.dispatchBacklog,this),this.gui.push(new ChatStatusMessage("Connecting...")),this.init(),void 0):this.gui.push(new ChatErrorMessage(this.errorstrings.requiresocket))},chat.prototype.l=function(){if(this.debug){var log=Function.prototype.bind.call(console.log,console);log.apply(console,arguments)}},chat.prototype.init=function(){this.sock=new WebSocket(this.server),this.sock.onopen=$.proxy(function(){var event={data:'OPEN ""'};this.parseAndDispatch(event)},this),this.sock.onerror=$.proxy(function(){var event={data:'ERR "socketerror"'};this.parseAndDispatch(event)},this),this.sock.onmessage=$.proxy(this.parseAndDispatch,this),this.sock.onclose=$.proxy(function(){var event={data:'CLOSE ""'};this.parseAndDispatch(event)},this),this.l=$.proxy(this.l,this),this.emit=$.proxy(this.emit,this)},chat.prototype.loadIgnoreList=function(){localStorage&&(this.ignorelist=JSON.parse(localStorage.chatignorelist||"{}"))},chat.prototype.parseAndDispatch=function(e){var eventname=e.data.split(" ",1)[0],handler="on"+eventname,obj=JSON.parse(e.data.substring(eventname.length+1));if(this.l(handler,obj),"PING"==eventname)return this.sock.send("PONG "+e.data.substring(eventname.length+1));if(this[handler]){var message=this[handler](obj);message&&($.inArray(eventname,this.controlevents)>=0?this.gui.push(message,"control"):this.gui.push(message))}},chat.prototype.dispatchBacklog=function(e){var handler="on"+e.event,obj={nick:e.username,data:e.data||e.target,features:e.features,timestamp:moment.utc(e.timestamp).valueOf()};return this[handler]?this[handler](obj):void 0},chat.prototype.emit=function(eventname,data){this.sock.send(eventname+" "+JSON.stringify(data))},chat.prototype.onOPEN=function(){this.connected=!0},chat.prototype.onCLOSE=function(){if(!this.dontconnect){var rand=this.connected?getRandomInt(501,3e3):getRandomInt(5e3,3e4);return setTimeout($.proxy(this.onRECONNECT,this),rand),this.connected=!1,new ChatStatusMessage("Disconnected... reconnecting in "+Math.round(rand/1e3)+" seconds")}},chat.prototype.onNAMES=function(data){if(!data.users||data.users.length<=0)return new ChatStatusMessage("Connected");for(var i=data.users.length-1;i>=0;i--){var u=data.users[i];this.users[u.nick]=new ChatUser(u),this.gui.autoCompletePlugin.addData(u.nick,1)}return new ChatStatusMessage("Connected. Server connections: "+data.connectioncount)},chat.prototype.onJOIN=function(data){this.users[data.nick]=new ChatUser(data),this.gui.autoCompletePlugin.addData(data.nick,1)},chat.prototype.onQUIT=function(data){this.users[data.nick]&&delete this.users[data.nick]},chat.prototype.onMSG=function(data){if(this.user.username==data.nick&&$.isArray(data.features)&&(this.user.features=data.features),"/me "===data.data.substring(0,4))var emoticon=data.data.substring(4);else var emoticon=data.data;if(-1!=$.inArray(emoticon,this.gui.emoticons)){if(this.previousemote&&this.previousemote.message==emoticon)return 1===this.previousemote.emotecount?(this.previousemote.emotecount=2,this.originemote&&(this.originemote.ui.remove(),this.originemote=null),this.previousemote):(this.previousemote.incEmoteCount(),void 0);this.previousemote=new ChatEmoteMessage(emoticon,data.timestamp)}else this.previousemote=null;var messageui=this.gui.resolveMessage(data);if(messageui&&this.previousemote&&(this.originemote=messageui),this.user.username!=data.nick||!messageui){if(this.ignorelist[data.nick.toLowerCase()])return;var user=this.users[data.nick];user?this.gui.autoCompletePlugin.addData(data.nick,data.timestamp):(user=new ChatUser(data),user.nick==this.user.nick&&(this.user=user)),user&&user.features.length!=data.features.length&&(this.users[data.nick]=user);var usermessage=new ChatUserMessage(data.data,user,data.timestamp);return this.previousemote&&(this.originemote=usermessage),usermessage}},chat.prototype.onMUTE=function(data){var suppressednick=data.data;return this.user.username.toLowerCase()==data.data.toLowerCase()?suppressednick="You have been":-1==$.inArray("admin",this.user.features)&&-1==$.inArray("moderator",this.user.features)&&-1==$.inArray("flair3",this.user.features)&&this.gui.removeUserMessages(data.data),new ChatCommandMessage(suppressednick+" muted by "+data.nick,data.timestamp)},chat.prototype.onUNMUTE=function(data){var suppressednick=data.data;return this.user.username.toLowerCase()==data.data.toLowerCase()&&(suppressednick="You have been"),new ChatCommandMessage(suppressednick+" unmuted by "+data.nick,data.timestamp)},chat.prototype.onBAN=function(data){var suppressednick=data.data;return this.user.username.toLowerCase()==data.data.toLowerCase()?suppressednick="You have been":-1==$.inArray("admin",this.user.features)&&-1==$.inArray("moderator",this.user.features)&&-1==$.inArray("flair3",this.user.features)&&this.gui.removeUserMessages(data.data),new ChatCommandMessage(suppressednick+" banned by "+data.nick,data.timestamp)},chat.prototype.onUNBAN=function(data){var suppressednick=data.data;return this.user.username.toLowerCase()==data.data.toLowerCase()&&(suppressednick="You have been"),new ChatCommandMessage(suppressednick+" unbanned by "+data.nick,data.timestamp)},chat.prototype.onERR=function(data){return("toomanyconnections"==data||"banned"==data)&&(this.dontconnect=!0),new ChatErrorMessage(this.errorstrings[data])},chat.prototype.onREFRESH=function(){window.location.href=window.location.href},chat.prototype.onRECONNECT=function(){this.init()},chat.prototype.onSUBONLY=function(data){var submode="on"==data.data?"enabled":"disabled";return new ChatCommandMessage("Subscriber only mode "+submode+" by "+data.nick,data.timestamp)},chat.prototype.onBROADCAST=function(data){return new ChatBroadcastMessage(data.data,data.timestamp)},chat.prototype.handleCommand=function(str){var parts=str.split(" ");if(command=parts[0].toLowerCase(),nickregex=/^[a-zA-Z0-9_]{4,20}$/,payload={},"/"===str.substring(0,1))return payload.data="/"+str,this.emit("MSG",payload),void 0;switch(this.l(command,parts),command){default:this.gui.push(new ChatErrorMessage("Unknown command"));break;case"emotes":this.gui.push(new ChatInfoMessage("Available emoticons: "+this.gui.emoticons.join(", ")));break;case"help":this.gui.push(new ChatInfoMessage("Available commands: /emotes /me /ignore (without arguments to list the nicks ignored) /unignore /highlight (highlights target nicks messages for easier visibility) /unhighlight /maxlines /mute /unmute /subonly /ban /ipban /unban (also unbans ip bans) /timestampformat"));break;case"me":payload.data="/"+str,this.emit("MSG",payload);break;case"ignore":if(!localStorage)return this.gui.push(new ChatErrorMessage("Ignore is unavailable, no localStorage")),void 0;if(!parts[1]){var nicks=[];return $.each(this.ignorelist,function(key){nicks.push(key)}),0==nicks.length?(this.gui.push(new ChatInfoMessage("Your ignore list is empty")),void 0):(this.gui.push(new ChatInfoMessage("Ignoring the following people: "+nicks.join(", "))),void 0)}var nick=parts[1].toLowerCase();if(!nickregex.test(nick))return this.gui.push(new ChatErrorMessage("Invalid nick - /ignore nick")),void 0;this.ignorelist[nick]=!0,this.gui.push(new ChatStatusMessage("Ignoring "+nick)),localStorage.chatignorelist=JSON.stringify(this.ignorelist),this.loadIgnoreList();break;case"unignore":if(!localStorage)return this.gui.push(new ChatErrorMessage("Ignore is unavailable, no localStorage")),void 0;if(!parts[1]||!nickregex.test(parts[1].toLowerCase()))return this.gui.push(new ChatErrorMessage("Invalid nick - /ignore nick")),void 0;var nick=parts[1].toLowerCase();delete this.ignorelist[nick],this.gui.push(new ChatStatusMessage(""+nick+" has been removed from your ignore list")),localStorage.chatignorelist=JSON.stringify(this.ignorelist),this.loadIgnoreList();break;case"mute":if(1==parts.length)return this.gui.push(new ChatInfoMessage("Usage: /"+command+" nick[ time]")),void 0;if(!nickregex.test(parts[1]))return this.gui.push(new ChatErrorMessage("Invalid nick - /"+command+" nick[ time]")),void 0;var duration=null;parts[2]&&(duration=this.parseTimeInterval(parts[2])),payload.data=parts[1],duration&&duration>0&&(payload.duration=duration),this.emit(command.toUpperCase(),payload);break;case"ban":case"ipban":if(parts.length<4)return this.gui.push(new ChatInfoMessage("Usage: /"+command+" nick time reason (time can be 'permanent')")),void 0;if(!nickregex.test(parts[1]))return this.gui.push(new ChatErrorMessage("Invalid nick")),void 0;if(payload.nick=parts[1],"ipban"==command&&(payload.banip=!0),/^perm/i.test(parts[2])?payload.ispermanent=!0:payload.duration=this.parseTimeInterval(parts[2]),payload.reason=parts.slice(3,parts.length).join(" "),!payload.reason)return this.gui.push(new ChatErrorMessage("Providing a reason is mandatory")),void 0;this.emit("BAN",payload);break;case"unmute":case"unban":if(1==parts.length)return this.gui.push(new ChatInfoMessage("Usage: /"+command+" nick")),void 0;if(!nickregex.test(parts[1]))return this.gui.push(new ChatErrorMessage("Invalid nick - /"+command+" nick")),void 0;payload.data=parts[1],this.emit(command.toUpperCase(),payload);break;case"subonly":if("on"!=parts[1]&&"off"!=parts[1])return this.gui.push(new ChatErrorMessage("Invalid argument - /"+command+" on/off")),void 0;payload.data=parts[1],this.emit(command.toUpperCase(),payload);break;case"maxlines":if(!parts[1])return this.gui.push(new ChatInfoMessage("Current number of lines shown: "+this.gui.maxlines)),void 0;var newmaxlines=Math.abs(parseInt(parts[1],10));if(!newmaxlines)return this.gui.push(new ChatErrorMessage("Invalid argument - /maxlines is expecting a number")),void 0;this.gui.saveChatOption("maxlines",newmaxlines),this.gui.maxlines=newmaxlines,this.gui.push(new ChatInfoMessage("Current number of lines shown: "+this.gui.maxlines));break;case"unhighlight":case"highlight":if(!parts[1]){var nicks=[];return $.each(this.gui.highlightnicks,function(k){nicks.push(k)}),this.gui.push(new ChatInfoMessage("Currenty highlighted users: "+nicks.join(", "))),void 0}if(!nickregex.test(parts[1]))return this.gui.push(new ChatErrorMessage("Invalid nick - /"+command+" nick")),void 0;var nick=parts[1].toLowerCase();"unhighlight"==command?(delete this.gui.highlightnicks[nick],this.gui.push(new ChatInfoMessage("No longer highlighting: "+nick))):(this.gui.highlightnicks[nick]=!0,this.gui.push(new ChatInfoMessage("Now highlighting: "+nick))),this.gui.saveChatOption("highlightnicks",this.gui.highlightnicks);break;case"timestampformat":if(!parts[1])return this.gui.push(new ChatInfoMessage("Current format: "+this.gui.timestampformat+" (the default is 'HH:mm', for more info: http://momentjs.com/docs/#/displaying/format/)")),void 0;var format=str.substring(command.length);if(!/^[a-z :.,-\\*]+$/i.test(format))return this.gui.push(new ChatErrorMessage("Invalid format, see: http://momentjs.com/docs/#/displaying/format/")),void 0;this.gui.timestampformat=format,this.gui.saveChatOption("timestampformat",format),this.gui.push(new ChatInfoMessage("New format: "+this.gui.timestampformat));break;case"broadcast":payload.data=str.substring(command.length+1),this.emit(command.toUpperCase(),payload)}},chat.prototype.parseTimeInterval=function(str){var nanoseconds=0,units={s:1e9,sec:1e9,secs:1e9,second:1e9,seconds:1e9,m:6e10,min:6e10,mins:6e10,minute:6e10,minutes:6e10,h:36e11,hr:36e11,hrs:36e11,hour:36e11,hours:36e11,d:864e11,day:864e11,days:864e11};return str.replace(/(\d+(?:\.\d*)?)([a-z]+)?/gi,function($0,number,unit){number*=unit?units[unit.toLowerCase()]||units.s:units.s,nanoseconds+=+number}),nanoseconds};
//# sourceMappingURL=engine.min.map