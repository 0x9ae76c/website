(function(){var kCodes={TAB:9};var mAutoComplete=function(input,options){this.input=input;this.shards={};return this.init(input,options)};mAutoComplete.prototype.getShardIdByTxt=function(txt){return txt.substr(0,1).toUpperCase()};mAutoComplete.prototype.addData=function(nick,weight){var id=this.getShardIdByTxt(nick);if(!this.shards[id]){this.shards[id]={}}if(this.shards[id][nick]){this.shards[id][nick].weight=weight}else{this.shards[id][nick]={nick:nick,weight:weight}}return this};mAutoComplete.prototype.init=function(input,options){return this};mAutoComplete.prototype.getCaretWord=function(inp){var pre=inp.val().substring(0,inp[0].selectionStart),post=inp.val().substring(inp[0].selectionStart),startCaret=pre.lastIndexOf(" ")+1,endCaret=post.indexOf(" ");if(startCaret>0){pre=pre.substring(startCaret)}if(endCaret>-1){post=post.substring(0,endCaret)}return{pre:pre,post:post,word:pre+post,startIndex:startCaret}};mAutoComplete.prototype.cmp=function(a,b){if(a.weight==b.weight){var a=a.nick.toLowerCase(),b=b.nick.toLowerCase();if(a==b){return 0}return a>b?1:-1}return a.weight>b.weight?-1:1};mAutoComplete.prototype.search=function(txt,limit){txt=txt.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&");var res=[],f=new RegExp("^"+txt,"i"),data=this.shards[this.getShardIdByTxt(txt)]||{};$.each(data,function(nick,v){if(f.test(nick)){res.push(v)}});res.sort(this.cmp);return res};$.fn.mAutoComplete=function(options){return this.each(function(){var settings=$.extend({minWordLength:3,maxResults:5,triggerKeys:[kCodes.TAB]},options);var results=new Array(),resultIndex=-1,searchWord="",originalTxt="",inp=$(this),autoComplete=new mAutoComplete(inp,options);inp.data("mAutoComplete",autoComplete);if(!inp[0].setSelectionRange){return this}var resetSearchResults=function(){results=[];resultIndex=-1;searchWord="";originalTxt=""};var checkCurrentWord=function(){searchWord=autoComplete.getCaretWord(inp);if(searchWord.word.length<settings.minWordLength){return}results=autoComplete.search(searchWord.word,settings.maxResults);originalTxt=inp.val()};var showAutoComplete=function(){resultIndex=(resultIndex>=results.length-1)?0:resultIndex+1;var replace=(results[resultIndex]||{}).nick;if(replace){var pre=originalTxt.substr(0,searchWord.startIndex),post=originalTxt.substr(searchWord.startIndex+searchWord.word.length);if(post.substring(0,1)!=" "||post.length==0){post=" "+post}if(replace.toLowerCase()!=searchWord.word.toLowerCase()){inp.focus();if(post.substring(0,1)!=" "||post.length==0){replace=replace+" "}inp.val(pre+replace+post);if(post.trim()==""){inp.blur().focus()}else{inp[0].setSelectionRange(pre.length+replace.length,pre.length+replace.length)}}}};inp.on({mousedown:function(e){resetSearchResults();return true},keydown:function(e){if($.inArray(e.keyCode,settings.triggerKeys)>=0){if(results.length<=0){resetSearchResults();checkCurrentWord()}showAutoComplete();return false}resetSearchResults();return true}})})}})();(function(w){w.requestAnimationFrame=w.requestAnimationFrame||w.mozRequestAnimationFrame||w.webkitRequestAnimationFrame||w.msRequestAnimationFrame;w.cancelAnimationFrame=w.cancelAnimationFrame||w.mozCancelAnimationFrame||w.webkitCancelAnimationFrame||w.msCancelAnimationFrame;if(!w.requestAnimationFrame){var aAnimQueue=[],iRequestId=0,iIntervalId;w.requestAnimationFrameLegacy=function(callback){aAnimQueue.push([++iRequestId,callback]);if(!iIntervalId){iIntervalId=setInterval(function(){if(aAnimQueue.length){aAnimQueue.shift()[1](+new Date())}else{clearInterval(iIntervalId);iIntervalId=undefined}},1000/50)}return iRequestId};w.cancelAnimationFrameLegacy=function(requestId){for(var i=0,j=aAnimQueue.length;i<j;i+=1){if(aAnimQueue[i][0]===requestId){aAnimQueue.splice(i,1);return}}}}})(window);(function($){destiny.fn.mCustomScrollbarPlugin=function(chat){this.chat=chat;return this.init()};$.extend(destiny.fn.mCustomScrollbarPlugin.prototype,{scrolledBottom:true,scrollLocked:true,chat:null,update:function(){this.chat.output.mCustomScrollbar("update")},init:function(){var self=this;self.chat.output.mCustomScrollbar({theme:"light-thin",scrollInertia:0,horizontalScroll:false,autoHideScrollbar:false,scrollButtons:{enable:true},callbacks:{onTotalScrollOffset:20,onTotalScrollBackOffset:20,onScrollStart:function(){self.scrolledBottom=false},onTotalScrollBack:function(){self.scrolledBottom=false},onTotalScroll:function(){self.scrolledBottom=true}}});self.chat.ui.addClass("chat-custom-scroll");return true},lockScroll:function(lock){this.scrollLocked=lock;return this},scrollBottom:function(){this.scrolledBottom=true;return this.chat.output.mCustomScrollbar("scrollTo","bottom")},isScrolledBottom:function(){return(!this.isScrollable()||this.scrolledBottom)},isScrollable:function(){return(this.chat.output.height()<this.chat.lines.height())},isScrollLocked:function(){return this.scrollLocked},scroll:function(to){var moveAmt=Math.floor(this.chat.output.height()/3),pos=Math.abs(this.chat.lines.parent().position().top);if(to=="up"){return this.chat.output.mCustomScrollbar("scrollTo",pos-moveAmt)}if(to=="down"){return this.chat.output.mCustomScrollbar("scrollTo",pos+moveAmt)}return this.chat.output.mCustomScrollbar("scrollTo",to)}})})(jQuery);(function(){cMenu=function(){return this};var showMenuUI=function(ui){clearTimeout(ui.data("hide-timeout"));ui.addClass("active").css("visibility","visible")};var hideMenuUI=function(ui){ui.removeClass("active");ui.data("hide-timeout",setTimeout(function(){ui.css("visibility","hidden")},250))};cMenu.addMenu=function(chat,e){e.on("click",".close",function(){cMenu.closeMenus(chat);return false});cMenu.prototype.scrollable.apply(e);chat.menus.push(e);return this};cMenu.closeMenus=function(chat){for(var i=0;i<chat.menus.length;++i){if(chat.menus[i].visible){this.prototype.hideMenu.call(chat.menus[i],chat)}}};cMenu.prototype.showMenu=function(chat){showMenuUI(this);this.visible=true;this.btn.addClass("active");this.scrollable.mCustomScrollbar("update");++chat.menuOpenCount};cMenu.prototype.hideMenu=function(chat){hideMenuUI(this);this.visible=false;this.btn.removeClass("active");--chat.menuOpenCount};cMenu.prototype.scrollable=function(){this.scrollable.mCustomScrollbar({theme:"light-thin",scrollInertia:0,horizontalScroll:false,autoHideScrollbar:true,scrollButtons:{enable:false}})};cUserTools=function(chat){var self=this;this.chat=chat;this.visible=false;this.label="";this.user=null;this.username="";this.ui=chat.ui.find(".user-tools");this.ui.user=this.ui.find(".user-tools-user");this.ui.muteForm=this.ui.find("#user-mute-form");this.ui.muteForm.on("submit",function(){var time=$(this).find("#banTimeLength");chat.engine.handleCommand("mute "+self.username+" "+time.val()+"m");time.val("0");self.hide();return false});this.ui.banForm=this.ui.find("#user-ban-form");this.ui.banForm.on("submit",function(){var time=$(this).find("#banTimeLength"),reason=$(this).find("#banReason"),ipBan=$(this).find("#ipBan"),cmd=(ipBan.val()=="1")?"ipban":"ban";chat.engine.handleCommand(cmd+" "+self.username+" "+time.val()+"m "+htmlEncode(reason.val()));time.val("0");reason.val("");ipBan.val("");self.hide();return false});this.ui.on("click","a#ignoreuser,a#unignoreuser",function(){var cmd=$(this).attr("href").substring(1);chat.engine.handleCommand(cmd+" "+self.username);self.hide();self.show(self.label,self.username,self.user);return false});this.ui.on("click","a#clearmessages",function(){chat.engine.handleCommand("mute "+self.username+" 1ms");self.hide();return false});this.ui.on("click","a.close",$.proxy(this.hide,this));return this};cUserTools.prototype.hide=function(){if(!this.visible){return}this.chat.lines.find(".focused").removeClass("focused");this.chat.ui.removeClass("focus-user");this.ui.removeClass("user-ignored");hideMenuUI(this.ui);this.visible=false;return false};cUserTools.prototype.show=function(label,username,user){if(this.visible&&username==this.username){return this.hide()}if(this.visible){this.hide()}this.ui.muteForm.hide();this.ui.banForm.hide();this.label=label;this.user=user;this.username=username;if(this.chat.engine.ignorelist[this.username]){this.ui.addClass("user-ignored")}this.ui.user.text(this.label);this.chat.lines.find('div[data-username="'+this.username+'"]').addClass("focused");this.chat.ui.addClass("focus-user");showMenuUI(this.ui);this.visible=true;return false}})();(function($){destiny.fn.EmoteFormatter=function(chat){this.emoteregex=new RegExp("\\b("+chat.emoticons.join("|")+")\\b");this.gemoteregex=new RegExp("\\b("+chat.emoticons.join("|")+")\\b","gm");return this};destiny.fn.EmoteFormatter.prototype.format=function(str,user){var emoteregex=(user.features||[]).length>0?this.gemoteregex:this.emoteregex;return str.replace(emoteregex,'<div title="$1" class="chat-emote chat-emote-$1"></div>')};destiny.fn.UrlFormatter=function(chat){var urlchars="\\w!\"#$%&'*+,-./:;<=>?@\\\\^`|~",tlds="(?:AC|AD|AE|AERO|AF|AG|AI|AL|AM|AN|AO|AQ|AR|ARPA|AS|ASIA|AT|AU|AW|AX|AZ|BA|BB|BD|BE|BF|BG|BH|BI|BIZ|BJ|BM|BN|BO|BR|BS|BT|BV|BW|BY|BZ|CA|CAT|CC|CD|CF|CG|CH|CI|CK|CL|CM|CN|CO|COM|COOP|CR|CU|CV|CW|CX|CY|CZ|DE|DJ|DK|DM|DO|DZ|EC|EDU|EE|EG|ER|ES|ET|EU|FI|FJ|FK|FM|FO|FR|GA|GB|GD|GE|GF|GG|GH|GI|GL|GM|GN|GOV|GP|GQ|GR|GS|GT|GU|GW|GY|HK|HM|HN|HR|HT|HU|ID|IE|IL|IM|IN|INFO|INT|IO|IQ|IR|IS|IT|JE|JM|JO|JOBS|JP|KE|KG|KH|KI|KM|KN|KP|KR|KW|KY|KZ|LA|LB|LC|LI|LK|LR|LS|LT|LU|LV|LY|MA|MC|MD|ME|MG|MH|MIL|MK|ML|MM|MN|MO|MOBI|MP|MQ|MR|MS|MT|MU|MUSEUM|MV|MW|MX|MY|MZ|NA|NAME|NC|NE|NET|NF|NG|NI|NL|NO|NP|NR|NU|NZ|OM|ORG|PA|PE|PF|PG|PH|PK|PL|PM|PN|POST|PR|PRO|PS|PT|PW|PY|QA|RE|RO|RS|RU|RW|SA|SB|SC|SD|SE|SG|SH|SI|SJ|SK|SL|SM|SN|SO|SR|ST|SU|SV|SX|SY|SZ|TC|TD|TEL|TF|TG|TH|TJ|TK|TL|TM|TN|TO|TP|TR|TRAVEL|TT|TV|TW|TZ|UA|UG|UK|US|UY|UZ|VA|VC|VE|VG|VI|VN|VU|WF|WS|XXX|YE|YT|ZA|ZM|ZW)",ipaddr="(?:(?:[0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}(?:[0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])";this.linkregex=new RegExp("(?:^|[\\s\\(\\[])(((?:https?|ftp):\\/\\/)?(?:[\\w]+(?::["+urlchars+"]*)?@)?(?:"+ipaddr+"|(?:(?:[\\w-]+\\.)+"+tlds+"))(?:\\/["+urlchars+"]*)?)(?=$|[\\s\\)\\]])","gim");return this};destiny.fn.UrlFormatter.prototype.encodeUrl=function(url){return url.replace(/[&"'<>]/g,function(c){var htmlencmap={"&":"&amp;","'":"&#39;",'"':"&quot;","<":"&lt;",">":"&gt;"};return htmlencmap[c]})};destiny.fn.UrlFormatter.prototype.format=function(str,user){var nsfw=(/\b(?:NSFW|NSFL|SPOILER)\b/i.test(str)),css=[],formatter=this;css.push("externallink");if(nsfw){css.push("nsfw-link")}return str.replace(this.linkregex,function(match,url,scheme){scheme=scheme?"":"http://";var encodedUrl=formatter.encodeUrl(url);return match.replace(url,'<a target="_blank" class="'+css.join(" ")+'" href="'+scheme+encodedUrl+'" rel="nofollow">'+encodedUrl+"</a>")})}})(jQuery);(function($){destiny.chat=[];$.fn.ChatGui=function(user,options){destiny.chat[0]=new chat(this,user,options);destiny.chat[0].start()};ChatGui=function(element,engine,options){this.ui=$(element);this.engine=engine;$.extend(this,options);return this.init()};$.extend(ChatGui.prototype,{theme:"dark",maxlines:500,lineCount:0,scrollPlugin:null,autoCompletePlugin:null,ui:null,lines:null,output:null,input:null,onSend:$.noop,userMessages:[],backlog:backlog,highlightregex:{},highlightnicks:{},notifications:true,lastMessage:null,menus:[],menuOpenCount:0,timestampformat:null,emoticons:[],formatters:[],init:function(){var chat=this;this.lines=this.ui.find(".chat-lines:first").eq(0);this.output=this.ui.find(".chat-output:first").eq(0);this.inputwrap=this.ui.find(".chat-input:first").eq(0);this.input=this.inputwrap.find(".input:first:first").eq(0);this.inputwrap.removeClass("hidden");this.formatters.push(new destiny.fn.EmoteFormatter(this));this.formatters.push(new destiny.fn.UrlFormatter(this));this.scrollPlugin=new destiny.fn.mCustomScrollbarPlugin(this);this.scrollPlugin.lockScroll(true);this.currenthistoryline=-1;this.storedinputline=null;if(window.localStorage){this.setupInputHistory()}this.setupNotifications();if(this.engine.user.username){this.highlightregex.user=new RegExp("\\b"+this.engine.user.username+"\\b","i")}this.autoCompletePlugin=this.input.mAutoComplete({minWordLength:2,maxResults:10}).data("mAutoComplete");for(var i=this.emoticons.length-1;i>=0;i--){this.autoCompletePlugin.addData(this.emoticons[i],2)}this.chatsettings=this.ui.find("#chat-settings:first").eq(0);this.chatsettings.btn=this.ui.find(".chat-settings-btn:first").eq(0);this.chatsettings.list=this.chatsettings.find("ul:first").eq(0);this.chatsettings.visible=false;this.chatsettings.scrollable=this.chatsettings.find(".scrollable:first");this.loadSettings();this.chatsettings.btn.on("click",function(e){e.preventDefault();if(chat.chatsettings.visible){return cMenu.prototype.hideMenu.call(chat.chatsettings,chat)}cMenu.closeMenus(chat);return cMenu.prototype.showMenu.call(chat.chatsettings,chat)});this.chatsettings.on("keypress blur","input[name=customhighlight]",function(e){var keycode=e.keyCode?e.keyCode:e.which;if(keycode&&keycode!=13){return}e.preventDefault();var data=$(this).val().trim().split(",");for(var i=data.length-1;i>=0;i--){data[i]=data[i].trim();if(!data[i]){data.splice(i,1)}}chat.saveChatOption("customhighlight",data);chat.loadCustomHighlights()});this.chatsettings.on("change",'input[type="checkbox"]',function(){var name=$(this).attr("name"),checked=$(this).is(":checked");switch(name){case"showtime":chat.saveChatOption(name,checked);chat.ui.toggleClass("chat-time",checked);chat.resize();break;case"hideflairicons":chat.saveChatOption(name,checked);chat.ui.toggleClass("chat-icons",(!checked));chat.resize();break;case"highlight":chat.saveChatOption(name,checked);break;case"notifications":if(!notifications){break}var permission;if(notifications.checkPermission){permission=notifications.checkPermission()}else{if(notifications.permission){switch(notifications.permission){case"default":permission=1;break;case"denied":permission=2;break;case"granted":permission=3;break}}}if(permission==1){notifications.requestPermission(function(){})}else{if(permission==2){chat.notifications=false;break}}chat.notifications=checked;chat.saveChatOption(name,checked);break}chat=null});this.userslist=this.ui.find("#chat-user-list:first").eq(0);this.userslist.btn=this.ui.find(".chat-users-btn:first").eq(0);this.userslist.visible=false;this.userslist.scrollable=this.userslist.find(".scrollable:first");this.userslist.btn.on("click",function(e){e.preventDefault();if(chat.userslist.visible){return cMenu.prototype.hideMenu.call(chat.userslist,chat)}cMenu.closeMenus(chat);var lists=chat.userslist.find("ul"),admins=[],vips=[],mods=[],bots=[],subs=[],plebs=[],elems={},usercount=0;for(var username in chat.engine.users){var u=chat.engine.users[username],elem=$('<li><a class="user '+u.features.join(" ")+'">'+u.username+"</a></li>");usercount++;elems[username.toLowerCase()]=elem;if($.inArray("bot",u.features)>=0){bots.push(username.toLowerCase())}else{if($.inArray("admin",u.features)>=0){admins.push(username.toLowerCase())}else{if($.inArray("vip",u.features)>=0){vips.push(username.toLowerCase())}else{if($.inArray("moderator",u.features)>=0){mods.push(username.toLowerCase())}else{if($.inArray("subscriber",u.features)>=0){subs.push(username.toLowerCase())}else{plebs.push(username.toLowerCase())}}}}}}chat.userslist.find("h5 span").text(usercount);var appendUsers=function(users,elem){if(users.length==0){elem.prev().hide().prev().hide();return}elem.prev().show().prev().show();users.sort();for(var i=0;i<users.length;i++){elem.append(elems[users[i]])}};lists.empty();appendUsers(admins,lists.filter(".admins"));appendUsers(vips,lists.filter(".vips"));appendUsers(mods,lists.filter(".moderators"));appendUsers(bots,lists.filter(".bots"));appendUsers(subs,lists.filter(".subs"));appendUsers(plebs,lists.filter(".plebs"));return cMenu.prototype.showMenu.call(chat.userslist,chat)});cMenu.addMenu(this,this.chatsettings);cMenu.addMenu(this,this.userslist);this.cUserTools=new cUserTools(this);this.userslist.on("click",".user",function(){var username=$(this).text().toLowerCase();chat.cUserTools.show($(this).text(),username,chat.engine.users[username])});this.lines.on("mousedown","div.user-msg a.user",function(){var username=$(this).closest(".user-msg").data("username");chat.cUserTools.show($(this).text(),username,chat.engine.users[username]);return false});this.ui.on("submit","form.chat-input",function(e){e.preventDefault();chat.send()});this.ui.on("click",".chat-send-btn",function(e){e.preventDefault();chat.send()});this.input.on("keydown mousedown",$.proxy(function(e){if(this.menuOpenCount>0){cMenu.closeMenus(this)}if(e.keyCode==33){this.scrollPlugin.scroll("up");return false}if(e.keyCode==34){this.scrollPlugin.scroll("down");return false}},this));this.output.on("mousedown",$.proxy(function(e){if(this.cUserTools.visible){this.cUserTools.hide()}if(this.menuOpenCount>0){cMenu.closeMenus(this)}},this));this.ui.find(".chat-tools-wrap button").removeAttr("disabled");return this.resize()},loadSettings:function(){var self=this,defaults={showtime:false,hideflairicons:false,highlight:true,notifications:false,maxlines:this.maxlines,timestampformat:"HH:mm"};this.timestampformat=self.getChatOption("timestampformat",defaults.timestampformat);this.maxlines=self.getChatOption("maxlines",defaults.maxlines);customhighlight=self.getChatOption("customhighlight",[]);this.chatsettings.find("input[name=customhighlight]").val(customhighlight.join(", "));this.loadCustomHighlights();this.chatsettings.find('input[type="checkbox"]').each(function(){var name=$(this).attr("name"),value=self.getChatOption(name,defaults[name]);$(this).attr("checked",value);switch(name){case"showtime":self.ui.toggleClass("chat-time",value);self.resize();break;case"hideflairicons":self.ui.toggleClass("chat-icons",(!value));self.resize();break}})},loadBacklog:function(){if(this.backlog.length>0){for(var i=this.backlog.length-1;i>=0;i--){var line=this.backlog[i],message=this.engine.dispatchBacklog(line);if(!message){continue}if($.inArray(line.event,this.engine.controlevents)>=0){this.put(message)}else{var m=this.put(message);this.handleHighlight(m,true)}}this.put(new ChatUIMessage("<hr/>"));this.scrollPlugin.update()}},lineCount:function(){return this.lines.children().length},push:function(message,state){var isScrolledBottom=this.scrollPlugin.isScrolledBottom();this.userMessages.push(message);this.put(message,state);this.scrollPlugin.update();if(isScrolledBottom&&this.scrollPlugin.isScrollLocked()){if(this.lineCount()>=this.maxlines){this.lines.children().slice(0,2+Math.floor(((this.lineCount()-this.maxlines)/this.maxlines)*100)).remove()}this.scrollPlugin.scrollBottom()}this.handleHighlight(message);return message},put:function(message,state){if(message instanceof ChatUserMessage){if(this.lastMessage&&this.lastMessage.user&&message.user&&this.lastMessage.user.username==message.user.username){message.ui=$(message.addonHtml())}else{message.ui=$(message.html())}if(message.user&&this.engine.user&&this.engine.user.username==message.user.username){message.ui.addClass("own-msg")}}else{message.ui=$(message.html())}message.ui.appendTo(this.lines);if(state!=undefined){message.status(state)}this.lastMessage=message;return message},send:function(){var str=this.input.val().trim();if(str!=""){this.input.val("").focus();this.onSend(str,this.input[0]);this.insertInputHistory(str);this.currenthistoryline=-1}str=null;return this},resize:function(){this.output.height(this.ui.height()-(this.inputwrap.height()+parseInt(this.inputwrap.css("margin-top"))));this.scrollPlugin.update();this.scrollPlugin.scrollBottom();return this},setupInputHistory:function(){var modifierpressed=false;var chat=this;$(this.input).on("keyup",function(e){if(e.shiftKey||e.metaKey||e.ctrlKey){modifierpressed=true}if((e.keyCode!=38&&e.keyCode!=40)||modifierpressed){modifierpressed=false;return}var num=e.keyCode==38?-1:1;if(chat.currenthistoryline<0&&e.keyCode==38){chat.currenthistoryline=chat.getInputHistory().length;chat.storedinputline=chat.input.val();if(chat.currenthistoryline<=0){return}}else{if(chat.currenthistoryline<0&&e.keyCode==40){return}}var index=chat.currenthistoryline+num;if(index>=chat.getInputHistory().length||index<0){if(index>=chat.getInputHistory().length){chat.input.val(chat.storedinputline);chat.currenthistoryline=-1}return}chat.currenthistoryline=index;chat.input.val(chat.getInputHistory()[index])})},getInputHistory:function(){return JSON.parse(localStorage.inputhistory||"[]")},setInputHistory:function(arr){localStorage.inputhistory=JSON.stringify(arr)},insertInputHistory:function(message){if(!window.localStorage){return}var history=this.getInputHistory();history.push(message);if(history.length>20){history.shift()}this.setInputHistory(history)},resolveMessage:function(data){var found=false;for(var i in this.userMessages){if(this.userMessages[i].message==data.data){this.userMessages[i].status();this.userMessages[i]=null;delete (this.userMessages[i]);found=true}}return found},setupNotifications:function(){window.notifications=window.webkitNotifications||window.mozNotifications||window.oNotifications||window.msNotifications||window.notifications||window.Notification;if(!notifications){$("#chat-settings input[name=notifications]").closest("label").text("Notifications are not supported by your browser")}if(!notifications||!this.engine.user.username||!this.getChatOption("notifications",false)){this.notifications=false}},showNotification:function(message){if(!this.notifications){return}var msg=message.message,title=(message.user)?""+message.user.username+" said ...":"Highlight ...",notif=null,self=this;if(msg.length>=30){msg=msg.substring(0,30)+"..."}if(this.currentnotification){this.currentnotification.close()}if(notifications.createNotification){notif=notifications.createNotification(destiny.cdn+"/chat/img/notifyicon.png",title,msg);this.currentnotification=notif;notif.show()}else{notif=new notifications(title,{icon:destiny.cdn+"/chat/img/notifyicon.png",body:msg,tag:message.timestamp.unix(),dir:"auto"});this.currentnotification=notif}setTimeout(function(){notif.close();if(notif===self.currentnotification){self.currentnotification=null}self=null},5000)},loadCustomHighlights:function(){this.highlightnicks=this.getChatOption("highlightnicks",{});var highlights=this.getChatOption("customhighlight",[]);if(highlights.length==0){return}for(var i=highlights.length-1;i>=0;i--){highlights[i]=highlights[i].replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")}this.highlightregex.custom=new RegExp("\\b(?:"+highlights.join("|")+")\\b","i")},handleHighlight:function(message,skipnotify){if(!message.user||message.user.username==this.engine.user.username){return}var u=message.user.username.toLowerCase();if(this.highlightnicks[u]){message.ui.addClass("highlight")}if(!this.highlightregex.user||!this.getChatOption("highlight",true)){return}if(this.highlightregex.user.test(message.message)||(this.highlightregex.custom&&this.highlightregex.custom.test(message.message))){message.ui.addClass("highlight");if(!skipnotify&&this.notifications){this.showNotification(message)}}},getChatOption:function(option,defaultvalue){var options=JSON.parse(localStorage.chatoptions||"{}");return(options[option]==undefined)?defaultvalue:options[option]},saveChatOption:function(option,value){var options=JSON.parse(localStorage.chatoptions||"{}");options[option]=value;localStorage.chatoptions=JSON.stringify(options)},removeUserMessages:function(username){this.lines.children('div[data-username="'+username.toLowerCase()+'"]').remove();this.resize()}});$(window).on({"resize.chat":function(){destiny.chat[0].gui.resize()},"focus.chat":function(){destiny.chat[0].gui.input.focus()},"load.chat":function(){destiny.chat[0].gui.input.focus()}});UserFeatures={PROTECTED:"protected",SUBSCRIBER:"subscriber",SUBSCRIBERT1:"subscribert1",SUBSCRIBERT2:"subscribert2",VIP:"vip",MODERATOR:"moderator",ADMIN:"admin",BOT:"bot",};ChatUser=function(args){args=args||{};this.username=args.nick||"";this.features=[];this.connections=0;args.features=args.features||[];$.extend(this,args);return this};ChatUser.prototype.getFeatureHTML=function(){var icons="";for(var i=0;i<this.features.length;i++){switch(this.features[i]){case UserFeatures.VIP:icons+='<i class="icon-vip" title="VIP"/>';break;case UserFeatures.MODERATOR:icons+='<i class="icon-moderator" title="Moderator"/>';break;case UserFeatures.ADMIN:icons+='<i class="icon-administrator" title="Administrator"/>';break;case UserFeatures.BOT:icons+='<i class="icon-bot" title="Bot"/>';break}}if($.inArray(UserFeatures.SUBSCRIBERT2,this.features)>=0){icons+='<i class="icon-subscribert2" title="Subscriber (T2)"/>'}else{if($.inArray(UserFeatures.SUBSCRIBERT1,this.features)>=0){icons+='<i class="icon-subscribert1" title="Subscriber (T1)"/>'}else{if($.inArray(UserFeatures.SUBSCRIBER,this.features)>=0){icons+='<i class="icon-subscriber" title="Subscriber"/>'}}}return icons};ChatUIMessage=function(html){return this.init(html)};ChatUIMessage.prototype.init=function(html){this.message=html;return this};ChatUIMessage.prototype.html=function(){return this.wrap(this.wrapMessage())};ChatUIMessage.prototype.wrap=function(html){return'<div class="ui-msg">'+html+"</div>"};ChatUIMessage.prototype.wrapMessage=function(){return this.message};ChatMessage=function(message,timestamp){return this.init(message,timestamp)};ChatMessage.prototype.init=function(message,timestamp){this.message=message;this.timestamp=moment.utc(timestamp).local();this.state=null;this.type="chat";this.timestampformat=destiny.chat[0].gui.timestampformat;return this};ChatMessage.prototype.status=function(state){if(this.ui){if(state){this.ui.addClass(state)}else{this.ui.removeClass(this.state)}}this.state=state;return this};ChatMessage.prototype.wrapTime=function(){return'<time title="'+this.timestamp.format("MMMM Do YYYY, h:mm:ss a")+'" datetime="'+this.timestamp.format("MMMM Do YYYY, h:mm:ss a")+'">'+this.timestamp.format(this.timestampformat)+"</time>"};ChatMessage.prototype.wrapMessage=function(){return $("<span/>").text(this.message).html()};ChatMessage.prototype.html=function(){return this.wrap(this.wrapTime()+" "+this.wrapMessage())};ChatMessage.prototype.wrap=function(content){return'<div class="'+this.type+'-msg">'+content+"</div>"};ChatErrorMessage=function(error,timestamp){this.init(error,timestamp);this.type="error";return this};$.extend(ChatErrorMessage.prototype,ChatMessage.prototype);ChatErrorMessage.prototype.html=function(){return this.wrap(this.wrapTime()+' <i class="icon-error"></i> '+this.wrapMessage())};ChatInfoMessage=function(message,timestamp){this.init(message,timestamp);this.type="info";return this};$.extend(ChatInfoMessage.prototype,ChatMessage.prototype);ChatInfoMessage.prototype.html=function(){return this.wrap(this.wrapTime()+' <i class="icon-info"></i> '+this.wrapMessage())};ChatCommandMessage=function(message,timestamp){this.init(message,timestamp);this.type="command";return this};$.extend(ChatCommandMessage.prototype,ChatMessage.prototype);ChatCommandMessage.prototype.html=function(){return this.wrap(this.wrapTime()+' <i class="icon-command"></i> '+this.wrapMessage())};ChatStatusMessage=function(message,timestamp){this.init(message,timestamp);this.type="status";return this};$.extend(ChatStatusMessage.prototype,ChatMessage.prototype);ChatStatusMessage.prototype.html=function(){return this.wrap(this.wrapTime()+' <i class="icon-status"></i> '+this.wrapMessage())};ChatUserMessage=function(message,user,timestamp){this.init(message,timestamp);this.type="user";this.isEmote=false;if(this.message.substring(0,4)==="/me "){this.isEmote=true;this.message=this.message.substring(4)}else{if(this.message.substring(0,2)==="//"){this.message=this.message.substring(1)}}this.isAddon=false;this.user=user;return this};$.extend(ChatUserMessage.prototype,ChatMessage.prototype);ChatUserMessage.prototype.wrap=function(html,css){if(this.user&&this.user.username){return'<div class="'+this.type+"-msg"+((css)?" "+css:"")+'" data-username="'+this.user.username.toLowerCase()+'">'+html+"</div>"}else{return'<div class="'+this.type+"-msg"+((css)?" "+css:"")+'">'+html+"</div>"}};ChatUserMessage.prototype.wrapUser=function(user){return((this.isEmote)?"":user.getFeatureHTML())+' <a class="user '+user.features.join(" ")+'">'+user.username+"</a>"};ChatUserMessage.prototype.wrapMessage=function(){var elem=$("<msg/>").text(this.message),encoded=elem.html();if(this.isEmote){elem.addClass("emote")}for(var i=0;i<destiny.chat[0].gui.formatters.length;++i){encoded=destiny.chat[0].gui.formatters[i].format(encoded,this.user)}elem.html(encoded);return elem.get(0).outerHTML};ChatUserMessage.prototype.html=function(){return this.wrap(this.wrapTime()+" "+((!this.isEmote)?"":"*")+this.wrapUser(this.user)+((!this.isEmote)?": ":" ")+this.wrapMessage())};ChatUserMessage.prototype.addonHtml=function(){if(this.isEmote){return this.wrap(this.wrapTime()+" *"+this.wrapUser(this.user)+" "+this.wrapMessage())}return this.wrap(this.wrapTime()+' <span class="continue">&gt;</span> '+this.wrapMessage(),"continue")}})(jQuery);function chat(element,user,options){this.server="ws://"+location.host+":9998/ws";this.connected=false;this.debug=false;this.users=[];this.ignorelist={};this.controlevents=["MUTE","UNMUTE","BAN","UNBAN","SUBONLY"];this.errorstrings={nopermission:"You do not have the required permissions to use that",protocolerror:"Invalid or badly formatted",needlogin:"You have to be logged in to use that",invalidmsg:"The message was invalid",throttled:"Throttled! You were trying to send messages too fast",duplicate:"The message is identical to the last one you sent",muted:"You are muted",submode:"The channel is currently in subscriber only mode",needbanreason:"Providing a reason for the ban is mandatory",banned:"You have been banned, disconnecting",requiresocket:"This chat requires WebSockets",toomanyconnections:"Only 3 concurrent connections allowed",socketerror:"Error contacting server",notfound:"The user was not found"};this.user=new ChatUser(user);this.gui=new ChatGui(element,this,options);return this}chat.prototype.start=function(){if(window.MozWebSocket){window.WebSocket=MozWebSocket}if(!window.WebSocket){return this.gui.push(new ChatErrorMessage(this.errorstrings.requiresocket))}this.gui.onSend=function(str){if(this.engine.user==null||!this.engine.user.username){return this.push(new ChatErrorMessage(this.errorstrings.requiresocket))}if(str.substring(0,1)==="/"){return this.engine.handleCommand(str.substring(1))}this.push(new ChatUserMessage(str,this.engine.user),(!this.engine.connected)?"unsent":"pending");this.engine.emit("MSG",{data:str})};this.gui.loadBacklog();this.loadIgnoreList();this.dispatchBacklog=$.proxy(this.dispatchBacklog,this);this.gui.push(new ChatStatusMessage("Connecting..."));this.init()};chat.prototype.l=function(){if(!this.debug){return}var log=Function.prototype.bind.call(console.log,console);log.apply(console,arguments)};chat.prototype.init=function(){this.sock=new WebSocket(this.server);this.sock.onopen=$.proxy(function(){var event={data:'OPEN ""'};this.parseAndDispatch(event)},this);this.sock.onerror=$.proxy(function(){var event={data:'ERR "socketerror"'};this.parseAndDispatch(event)},this);this.sock.onmessage=$.proxy(this.parseAndDispatch,this);this.sock.onclose=$.proxy(function(){var event={data:'CLOSE ""'};this.parseAndDispatch(event)},this);this.l=$.proxy(this.l,this);this.emit=$.proxy(this.emit,this)};chat.prototype.loadIgnoreList=function(){if(!localStorage){return}this.ignorelist=JSON.parse(localStorage.chatignorelist||"{}")};chat.prototype.parseAndDispatch=function(e){var eventname=e.data.split(" ",1)[0],handler="on"+eventname,obj=JSON.parse(e.data.substring(eventname.length+1));this.l(handler,obj);if(eventname=="PING"){return this.sock.send("PONG "+e.data.substring(eventname.length+1))}if(this[handler]){var message=this[handler](obj);if(message){if($.inArray(eventname,this.controlevents)>=0){this.gui.push(message,"control")}else{this.gui.push(message)}}}};chat.prototype.dispatchBacklog=function(e){var handler="on"+e.event,obj={nick:e.username,data:e.data||e.target,features:e.features,timestamp:moment.utc(e.timestamp).valueOf()};if(this[handler]){return this[handler](obj)}};chat.prototype.emit=function(eventname,data){this.sock.send(eventname+" "+JSON.stringify(data))};chat.prototype.onOPEN=function(){this.connected=true};chat.prototype.onCLOSE=function(){if(this.dontconnect){return}var rand=((this.connected)?getRandomInt(1,3):getRandomInt(5,30));setTimeout($.proxy(this.onRECONNECT,this),rand*1000);this.connected=false;return new ChatStatusMessage("Disconnected... reconnecting in "+rand+" seconds")};chat.prototype.onNAMES=function(data){if(!data.users||data.users.length<=0){return new ChatStatusMessage("Connected")}for(var i=data.users.length-1;i>=0;i--){var u=data.users[i];this.users[u.nick]=new ChatUser(u);this.gui.autoCompletePlugin.addData(u.nick,1)}return new ChatStatusMessage("Connected. Server connections: "+data.connectioncount)};chat.prototype.onJOIN=function(data){this.users[data.nick]=new ChatUser(data);this.gui.autoCompletePlugin.addData(data.nick,1)};chat.prototype.onQUIT=function(data){if(this.users[data.nick]){this.users[data.nick].connections--;if(this.users[data.nick].connections<=0){delete (this.users[data.nick])}}};chat.prototype.onMSG=function(data){if(this.user.username==data.nick&&$.isArray(data.features)){this.user.features=data.features}if(this.user.username!=data.nick||!this.gui.resolveMessage(data)){if(this.ignorelist[data.nick.toLowerCase()]){return}var user=this.users[data.nick];if(!user||user.features.length!=data.features.length){user=this.users[data.nick]=new ChatUser(data)}this.gui.autoCompletePlugin.addData(data.nick,data.timestamp);return new ChatUserMessage(data.data,user,data.timestamp)}};chat.prototype.onMUTE=function(data){var suppressednick=data.data;if(this.user.username.toLowerCase()==data.data.toLowerCase()){suppressednick="You have been"}else{this.gui.removeUserMessages(data.data)}return new ChatCommandMessage(suppressednick+" muted by "+data.nick,data.timestamp)};chat.prototype.onUNMUTE=function(data){var suppressednick=data.data;if(this.user.username.toLowerCase()==data.data.toLowerCase()){suppressednick="You have been"}return new ChatCommandMessage(suppressednick+" unmuted by "+data.nick,data.timestamp)};chat.prototype.onBAN=function(data){var suppressednick=data.data;if(this.user.username.toLowerCase()==data.data.toLowerCase()){suppressednick="You have been"}else{this.gui.removeUserMessages(data.data)}return new ChatCommandMessage(suppressednick+" banned by "+data.nick,data.timestamp)};chat.prototype.onUNBAN=function(data){var suppressednick=data.data;if(this.user.username.toLowerCase()==data.data.toLowerCase()){suppressednick="You have been"}return new ChatCommandMessage(suppressednick+" unbanned by "+data.nick,data.timestamp)};chat.prototype.onERR=function(data){if(data=="toomanyconnections"||data=="banned"){this.dontconnect=true}return new ChatErrorMessage(this.errorstrings[data])};chat.prototype.onREFRESH=function(){window.location.href=window.location.href};chat.prototype.onRECONNECT=function(){this.init()};chat.prototype.onSUBONLY=function(data){var submode=data.data=="on"?"enabled":"disabled";return new ChatCommandMessage("Subscriber only mode "+submode+" by "+data.nick,data.timestamp)};chat.prototype.handleCommand=function(str){var parts=str.split(" ");command=parts[0].toLowerCase(),nickregex=/^[a-zA-Z0-9_]{4,20}$/,payload={};if(str.substring(0,1)==="/"){payload.data="/"+str;this.emit("MSG",payload);return}this.l(command,parts);switch(command){default:this.gui.push(new ChatErrorMessage("Unknown command"));break;case"emotes":this.gui.push(new ChatInfoMessage("Available emoticons: "+emoticons.join(", ")));break;case"help":this.gui.push(new ChatInfoMessage("Available commands: /emotes /me /ignore (without arguments to list the nicks ignored) /unignore /highlight (highlights target nicks messages for easier visibility) /unhighlight /maxlines /mute /unmute /subonly /ban /ipban /unban (also unbans ip bans) /timestampformat"));break;case"me":payload.data="/"+str;this.emit("MSG",payload);break;case"ignore":if(!localStorage){this.gui.push(new ChatErrorMessage("Ignore is unavailable, no localStorage"));return}if(!parts[1]){var nicks=[];$.each(this.ignorelist,function(key){nicks.push(key)});if(nicks.length==0){this.gui.push(new ChatInfoMessage("Your ignore list is empty"));return}this.gui.push(new ChatInfoMessage("Ignoring the following people: "+nicks.join(", ")));return}var nick=parts[1].toLowerCase();if(!nickregex.test(nick)){this.gui.push(new ChatErrorMessage("Invalid nick - /ignore nick"));return}this.ignorelist[nick]=true;this.gui.push(new ChatStatusMessage("Ignoring "+nick));localStorage.chatignorelist=JSON.stringify(this.ignorelist);this.loadIgnoreList();break;case"unignore":if(!localStorage){this.gui.push(new ChatErrorMessage("Ignore is unavailable, no localStorage"));return}if(!parts[1]||!nickregex.test(parts[1].toLowerCase())){this.gui.push(new ChatErrorMessage("Invalid nick - /ignore nick"));return}var nick=parts[1].toLowerCase();delete (this.ignorelist[nick]);this.gui.push(new ChatStatusMessage(""+nick+" has been removed from your ignore list"));localStorage.chatignorelist=JSON.stringify(this.ignorelist);this.loadIgnoreList();break;case"mute":if(parts.length==1){this.gui.push(new ChatInfoMessage("Usage: /"+command+" nick[ time]"));return}if(!nickregex.test(parts[1])){this.gui.push(new ChatErrorMessage("Invalid nick - /"+command+" nick[ time]"));return}var duration=null;if(parts[2]){duration=this.parseTimeInterval(parts[2])}payload.data=parts[1];if(duration&&duration>0){payload.duration=duration}this.emit(command.toUpperCase(),payload);break;case"ban":case"ipban":if(parts.length<4){this.gui.push(new ChatInfoMessage("Usage: /"+command+" nick time reason (time can be 'permanent')"));return}if(!nickregex.test(parts[1])){this.gui.push(new ChatErrorMessage("Invalid nick"));return}payload.nick=parts[1];if(command=="ipban"){payload.banip=true}if(/^perm/i.test(parts[2])){payload.ispermanent=true}else{payload.duration=this.parseTimeInterval(parts[2])}payload.reason=parts.slice(3,parts.length).join(" ");if(!payload.reason){this.gui.push(new ChatErrorMessage("Providing a reason is mandatory"));return}this.emit("BAN",payload);break;case"unmute":case"unban":if(parts.length==1){this.gui.push(new ChatInfoMessage("Usage: /"+command+" nick"));return}if(!nickregex.test(parts[1])){this.gui.push(new ChatErrorMessage("Invalid nick - /"+command+" nick"));return}payload.data=parts[1];this.emit(command.toUpperCase(),payload);break;case"subonly":if(parts[1]!="on"&&parts[1]!="off"){this.gui.push(new ChatErrorMessage("Invalid argument - /"+command+" on/off"));return}payload.data=parts[1];this.emit(command.toUpperCase(),payload);break;case"maxlines":if(!parts[1]){this.gui.push(new ChatInfoMessage("Current number of lines shown: "+this.gui.maxlines));return}var newmaxlines=Math.abs(parseInt(parts[1],10));if(!newmaxlines){this.gui.push(new ChatErrorMessage("Invalid argument - /maxlines is expecting a number"));return}this.gui.saveChatOption("maxlines",newmaxlines);this.gui.maxlines=newmaxlines;this.gui.push(new ChatInfoMessage("Current number of lines shown: "+this.gui.maxlines));break;case"unhighlight":case"highlight":if(!parts[1]){var nicks=[];$.each(this.gui.highlightnicks,function(k,v){nicks.push(k)});this.gui.push(new ChatInfoMessage("Currenty highlighted users: "+nicks.join(", ")));return}if(!nickregex.test(parts[1])){this.gui.push(new ChatErrorMessage("Invalid nick - /"+command+" nick"));return}var nick=parts[1].toLowerCase();if(command=="unhighlight"){delete (this.gui.highlightnicks[nick]);this.gui.push(new ChatInfoMessage("No longer highlighting: "+nick))}else{this.gui.highlightnicks[nick]=true;this.gui.push(new ChatInfoMessage("Now highlighting: "+nick))}this.gui.saveChatOption("highlightnicks",this.gui.highlightnicks);break;case"timestampformat":if(!parts[1]){this.gui.push(new ChatInfoMessage("Current format: "+this.gui.timestampformat+" (the default is 'HH:mm', for more info: http://momentjs.com/docs/#/displaying/format/)"));return}var format=str.substring(command.length);if(!/^[a-z :.,-\\*]+$/i.test(format)){this.gui.push(new ChatErrorMessage("Invalid format, see: http://momentjs.com/docs/#/displaying/format/"));return}this.gui.timestampformat=format;this.gui.saveChatOption("timestampformat",format);this.gui.push(new ChatInfoMessage("New format: "+this.gui.timestampformat));break}};chat.prototype.parseTimeInterval=function(str){var nanoseconds=0,units={s:1000000000,sec:1000000000,secs:1000000000,second:1000000000,seconds:1000000000,m:60000000000,min:60000000000,mins:60000000000,minute:60000000000,minutes:60000000000,h:3600000000000,hr:3600000000000,hrs:3600000000000,hour:3600000000000,hours:3600000000000,d:86400000000000,day:86400000000000,days:86400000000000,};str.replace(/(\d+(?:\.\d*)?)([a-z]+)?/ig,function($0,number,unit){if(unit){number*=units[unit.toLowerCase()]||units.s}else{number*=units.s}nanoseconds+=+number});return nanoseconds};