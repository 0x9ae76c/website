function htmlEncode(value){return String(value).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}$.fn.loadImages=function(options){options=$.extend({},{attr:"src"},options);return this.find("img[data-"+options.attr+"]").each(function(){var img=$(this),url=img.data(options.attr);if(url!=""&&url!=null){var nimg=img.clone();nimg.one("load",function(){img.replaceWith(nimg)});nimg.removeAttr(options.attr).removeAttr("data-"+options.attr).attr("src",url)}})};function getChampIcon(name){return destiny.cdn+"/web/img/lol/champions/"+name.replace(" ","-").replace("'","").replace(".","").toLowerCase()+".png"}$.fn.sortElements=(function(){var sort=[].sort;return function(comparator,getSortable){getSortable=getSortable||function(){return this};var placements=this.map(function(){var sortElement=getSortable.call(this),parentNode=sortElement.parentNode;var nextSibling=parentNode.insertBefore(document.createTextNode(""),sortElement.nextSibling);return function(){if(parentNode===this){throw new Error("You can't sort elements if any one is a descendant of another.")}parentNode.insertBefore(this,nextSibling);parentNode.removeChild(nextSibling)}});return sort.call(this,comparator).each(function(i){placements[i].call(getSortable.call(this))})}})();function getRandomInt(min,max){return Math.floor(Math.random()*(max-min+1))+min}String.prototype.ltrim=function(chars){chars=chars||"\\s*";return this.replace(new RegExp("^["+chars+"]+","g"),"")};String.prototype.rtrim=function(chars){chars=chars||"\\s*";return this.replace(new RegExp("["+chars+"]+$","g"),"")};String.prototype.trim=function(chars){return this.rtrim(chars).ltrim(chars)};if(!String.prototype.format){String.prototype.format=function(){var args=arguments;return this.replace(/{(\d+)}/g,function(match,number){return typeof args[number]!="undefined"?args[number]:match})}}destiny={cdn:"",token:"",baseUrl:"/",timeout:15000,fn:{}};destiny.init=function(args){$.extend(destiny,args)};(function($){var DestinyFeedConsumer=function(args){this.args=$.extend({polling:null,init:$.noop(),success:$.noop(),error:$.noop(),pollexecute:$.noop(),type:"GET",dataType:"json",start:true,ui:null,},args);return this.init()};$.extend(DestinyFeedConsumer.prototype,{polling:null,args:null,init:function(){if($.isFunction(this.args.init)){this.args.init.call(this,this.args)}if(this.args.ui!=null){if($(this.args.ui).get(0)==null){return}if($(this.args.ui).find(".loading").get(0)!=null){this.args.start=true}}if(this.args.start){this.load()}this.args.start=true;this.setupPoll();return this},load:function(){$.ajax(this.args);return this},setupPoll:function(){var self=this;if(self.polling!=null){self.stopPolling()}if(self.args.polling!=null&&typeof self.args.polling=="number"){self.polling=setInterval(function(){if($.isFunction(self.args.pollexecute)&&false===self.args.pollexecute.call(self,self.args)){return}self.load()},self.args.polling*1000)}},stopPolling:function(){clearInterval(this.polling)},resetPoll:function(){this.setupPoll()}});window.DestinyFeedConsumer=DestinyFeedConsumer})(jQuery);$(function(){$('a[rel="resetteam"]').click(function(){if(confirm("This will remove all champions, reset scores, transfers and credits as well as remove all purchases?\r\nThis cannot be undone. Are you sure?")){if(confirm("Real talk now... are you sure?")){$.ajax({type:"POST",async:false,url:destiny.baseUrl+"fantasy/team/reset",complete:function(){window.location.reload()}})}}return false})});$(function(){var twitch=$("#twitchpanel"),twitchElements=$("#twitch-elements"),chat=twitchElements.find("#twitch-chat"),player=twitchElements.find("#twitch-player"),popoutChatBtn=twitch.find("#popoutchat"),popoutVideoBtn=twitch.find("#popoutvideo"),bigscreenmodeBtn=twitch.find("#bigscreenmode");var twitchChat={popup:null,toggle:function(){if(this.popup==null){this.popOut()}else{this.popIn()}},popOut:function(){popoutChatBtn.attr("title","Re-embed chat").addClass("btn-down");if(twitchElements.children().length<=1){twitch.removeClass("split-view single-view").addClass("no-view")}else{twitch.removeClass("split-view").addClass("single-view")}chat.detach();this.popup=window.open(twitch.data("chat-embed"),"_blank","height=500,width=420,scrollbars=0,toolbar=0,location=0,status=no,menubar=0,resizable=0,dependent=0")},popIn:function(){popoutChatBtn.attr("title","Pop-out chat").removeClass("btn-down");if(twitchElements.children().length<=0){twitch.removeClass("split-view").addClass("single-view")}else{twitch.addClass("split-view").removeClass("single-view")}if(this.popup!=null){this.popup.close();this.popup=null}chat.appendTo(twitchElements)}};var twitchVideo={popup:null,toggle:function(){if(this.popup==null){this.popOut()}else{this.popIn()}},popOut:function(){popoutVideoBtn.attr("title","Re-embed video").addClass("btn-down");if(twitchElements.children().length<=1){twitch.removeClass("split-view single-view").addClass("no-view")}else{twitch.removeClass("split-view").addClass("single-view")}player.detach();this.popup=window.open(twitch.data("video-embed"),"_blank","height=420,width=720,scrollbars=0,toolbar=0,location=0,status=no,menubar=0,resizable=1,dependent=0")},popIn:function(){popoutVideoBtn.attr("title","Pop-out video").removeClass("btn-down");if(twitchElements.children().length<=0){twitch.removeClass("split-view").addClass("single-view")}else{twitch.addClass("split-view").removeClass("single-view")}if(this.popup!=null){this.popup.close();this.popup=null}player.prependTo(twitchElements)}};popoutChatBtn.on("click",function(){twitchChat.toggle()});popoutVideoBtn.on("click",function(){twitchVideo.toggle()});bigscreenmodeBtn.on("click",function(){var nw=window.open("/bigscreen","bigscreen");var tw=twitch.detach();$(nw).on("beforeunload",function(){$("#header-band").after(tw)});return false});var offlineAdvert={ui:$('<div id="player-ads" class="clearfix" />'),polling:5000,intervalId:null,init:function(){var self=this;self.ui.html('<div id="player-ads-video"><p>The stream is offline. This screen will automatically <a href="#" id="close-player-ad" title="Close">close</a> when stream is live.<br />Click <a title="Google Calendar" href="/schedule">here</a> to see when he\'ll be streaming next</p><iframe id="youtube-embed" src="http://www.youtube.com/embed/?listType=user_uploads&list='+twitch.data("youtube-user")+'&showinfo=1" frameborder="0" allowfullscreen></iframe></div>');self.ui.on("click","#close-player-ad",function(){self.destroy();return false});self.ui.find(".thumbnail").tooltip({placement:"left"});player.append(self.ui);self.ui.loadImages()},initTimer:function(){var self=this;self.intervalId=setInterval(function(){if(twitch.hasClass("offline")&&false==player.hasClass("defocus")){player.addClass("defocus");self.ui.detach();self.init()}else{if(twitch.hasClass("online")&&player.hasClass("defocus")){clearInterval(self.intervalId);player.removeClass("defocus");self.destroy()}}},5000)},destroy:function(){var self=this;clearInterval(self.intervalId);player.removeClass("defocus");self.ui.remove()}};offlineAdvert.initTimer()});$(function(){$(".fantasy-team-bar").each(function(){var fantasyTeamBar=$(this),championUi=fantasyTeamBar.find(".team-champions");var updateTeamAndChampions=function(team,champions){fantasyTeamBar.removeAttr("data-team");fantasyTeamBar.data("team",team);fantasyTeamBar.find(".team-stat.scoreValue .stat-value").text(team.scoreValue);fantasyTeamBar.find(".team-stat.credits .stat-value").text(Math.floor(team.credits));fantasyTeamBar.find(".team-stat.transfersRemaining .stat-value").text(team.transfersRemaining);if(champions!=undefined){championUi.find(".champion-slot").each(function(index){setupChampionSlot($(this),champions[index])})}};var setupChampionSlot=function(slot,champion){var img=slot.find(".thumbnail img");if(champion!=undefined){slot.data("champion",champion);slot.removeAttr("data-champion");slot.removeClass("champion-slot-full champion-slot-empty champion-illegal champion-free");slot.addClass("champion-slot-full");slot.addClass((champion.unlocked==1)?"champion-unlocked":((champion.championFree=="1")?"champion-free":"champion-illegal"));slot.attr("title",champion.championName);img.attr("alt",champion.championName);img.attr("src",getChampIcon(champion.championName))}else{img.attr("alt","");img.attr("src",destiny.cdn+"/web/img/320x320.gif");slot.removeClass("champion-slot-full champion-slot-empty champion-illegal champion-free");slot.addClass("champion-slot-empty");slot.attr("title","None")}};var getChampions=function(){var champions=[];championUi.find(".champion-slot-full").each(function(){champions.push($(this).data("champion"))});return champions};var getTeam=function(){return fantasyTeamBar.data("team")};var showTeamMaker=function(){if(championUi.hasClass("disabled")){return}DestinyTMI.show({team:getTeam(),champions:getChampions(),onsave:updateTeamAndChampions,onshow:function(){DestinyTMI.lockedState=true;DestinyTMI.setProgress('<span class="busy"><i class="icon-time icon-white subtle"></i> Loading your champions ...</span>');new DestinyFeedConsumer({url:destiny.baseUrl+"fantasy/team/champions.json",success:function(teamChampionResponse,textStatus){if(teamChampionResponse!=null&&teamChampionResponse.success==true){DestinyTMI.lockedState=false;DestinyTMI.setUnlockedChampions(teamChampionResponse.data);DestinyTMI.hideProgress();DestinyTMI.ui.loadImages();DestinyTMI.positionTeamMaker()}}})},onconfirm:function(){var champions=this.getChampionIds();if(champions.length>parseInt(this.settings.maxChampions)){throw"At most "+this.settings.maxChampions+" champions required"}if(champions.length<parseInt(this.settings.minChampions)){throw"At least "+this.settings.minChampions+" champions required"}return true}});return false};var manageTeamEl=fantasyTeamBar.find(".team-champions");manageTeamEl.find(".team-champions-slots").on("click",function(){$(this).popover("hide");showTeamMaker();return false});if(getChampions().length<=0){$(window).on("load",function(){manageTeamEl.find(".team-champions-slots").popover({placement:"left",title:"You have no champions!",trigger:"manual",html:true,content:"Click here to add champions to your team."}).popover("show")})}new DestinyFeedConsumer({url:destiny.baseUrl+"fantasy/team/info.json",polling:60,ui:".fantasy-team-bar",ifModified:true,start:false,data:{teamId:getTeam().teamId},success:function(team,textStatus){if(textStatus=="notmodified"){return}if(team!=null){updateTeamAndChampions(team,team.champions)}}})})});(function(){DestinyTMI={ui:null,overlay:null,champSelector:null,champSearch:null,teamSelection:null,enabled:true,team:null,teamPersistedChampions:null,onshow:null,onconfirm:null,onsave:null,settings:null,lockedState:false,unlockedChampions:null,toolsUI:null,progressModal:null,teamSelection:null,teamCurrency:null,show:function(options){var self=this;options=$.extend({team:null,champions:[]},options);self.team=$.extend({},options.team);self.teamPersistedChampions=$.extend({},options.champions);self.settings=self.ui.data("settings");self.onconfirm=options.onconfirm;self.onsave=options.onsave;self.onshow=options.onshow;self.showOverlay();new DestinyFeedConsumer({url:destiny.baseUrl+"Fantasy/Champions.json",success:function(championsResponse,textStatus){self.setupChampions(championsResponse);self.enableChampions();self.resetChampionSelection();self.setupChampionSlots(self.teamPersistedChampions);self.updateTeamCreditUi();self.showOverlay();self.ui.show();self.onshow.call(self)}})},error:function(e){var consoleUi=this.ui.find(".team-maker-console").html(e).show();window.clearTimeout(consoleUi.data("hideTimeout"));consoleUi.data("hideTimeout",window.setTimeout(function(){consoleUi.fadeOut(300)},2000))},showOverlay:function(){var self=this;self.overlay.detach().appendTo("body");self.ui.css("top","0");$(window).off("resize.tmoverlay").on("resize.tmoverlay",function(){self.sizeOverlay()});self.sizeOverlay()},sizeOverlay:function(){var self=this;self.overlay.width($("body").outerWidth()).height($("body").outerHeight()).show();self.positionTeamMaker()},positionTeamMaker:function(){var self=this,top=(((parseInt($(window).height())/2)+$(window).scrollTop())-parseInt(self.ui.height())/2),left=((parseInt($(window).width())/2)-parseInt(self.ui.width())/2);self.ui.css({top:((top>40)?top:40)+"px",left:left+"px"})},hide:function(){$(window).off("resize.tmoverlay");$(window).off("scroll.tmui");this.ui.hide();this.overlay.hide()},resetChampionSelection:function(){this.champSelector.find(".champion").addClass("champion-locked").removeClass("champion-unlocked")},setupChampions:function(champions){var teamChampionSelector=this.ui.find(".team-maker-selection-inner").empty();for(var x=0;x<champions.length;x++){var champUi=$('<div data-value="'+champions[x].championValue+'" data-id="'+champions[x].championId+'" data-name="'+htmlEncode(champions[x].championName)+'" class="champion'+((champions[x].championFree=="1")?" champion-free":" champion-locked")+'" style="float:left; width: 10%;"><div class="clearfix"><div class="thumbnail" title="'+htmlEncode(champions[x].championName)+'"><img style="max-width:100%;" src="'+destiny.cdn+'/web/img/320x320.gif" data-src="'+getChampIcon(champions[x].championName)+'" /><span class="championMultiplier" title="Score Multiplier"><i class="icon-star icon-white subtle"></i>'+Math.round(champions[x].championMultiplier*100)+'%</span><div class="champion-values clearfix"><span class="championValue"><i class="icon-money"></i>'+champions[x].championValue+'</span><span class="championUnlocked">Unlocked</span><span class="championFree">Free</span></div></div></div></div>').data("champion",champions[x]);teamChampionSelector.append(champUi)}DestinyTMI.ui.find(".champ-search > input").removeAttr("disabled").val("");DestinyTMI.ui.find(".champ-filter.active").removeClass("active").addClass("btn-inverse");DestinyTMI.ui.removeClass("filter-owned filter-free")},setUnlockedChampions:function(champions){this.unlockedChampions=champions;for(var i=0;i<this.unlockedChampions.length;++i){this.unlockChampion(this.unlockedChampions[i])}},unlockChampion:function(champ){this.champSelector.find('.champion[data-id="'+champ.championId+'"]').removeClass("champion-locked").addClass("champion-unlocked")},getChampions:function(){var champions=[],slots=this.teamSelection.find(".champion-slot-full");for(var i=0;i<slots.length;++i){champions.push($(slots.get(i)).data("champion"))}return champions},getChampionIds:function(){var champions=[],slots=this.teamSelection.find(".champion-slot-full");for(var i=0;i<slots.length;++i){champions.push($(slots.get(i)).data("champion").championId)}return champions},setupChampionSlots:function(champions){var self=this;self.ui.find(".champion-slot").each(function(index){var slot=$(this),champ=champions[index];self.resetSlotState(slot);if(champ!=undefined&&(champ.unlocked==1||champ.championFree==1)){self.convertFromEmptySlot(slot,champ);self.disableChampion(champ)}else{self.convertToEmptySlot(slot)}})},updateTeamCreditUi:function(){var self=this;self.teamCurrency.find(".credits").text(Math.floor(self.team.credits));self.teamCurrency.find(".transfers").text(self.team.transfersRemaining)},enableChampions:function(){this.champSelector.find(".champion.disabled").removeClass("disabled")},enableChampion:function(champ){this.champSelector.find('.champion[data-name="'+champ.championName+'"]').removeClass("disabled")},disableChampion:function(champ){this.champSelector.find('.champion[data-name="'+champ.championName+'"]').addClass("disabled")},convertFromEmptySlot:function(slot,champ){slot.removeClass("champion-slot-empty").addClass("champion-slot-full").data("champion",champ).attr("data-championid",champ.championId);slot.find(".thumbnail").attr("title",champ.championName);slot.find("img").attr("src",getChampIcon(champ.championName))},convertToEmptySlot:function(slot){slot.removeClass("champion-slot-full").addClass("champion-slot-empty").data("champion",null).removeAttr("data-championid");var img=slot.find("img");if(slot.hasClass("champion-transfer")){img.attr("src",getChampIcon(slot.data("transferOut").championName))}else{img.attr("src",destiny.cdn+"/web/img/320x320.gif")}},resetSlotState:function(slot){slot.removeClass("champion-transfer").data("transferOut",null).find(".icon-transfer-in,.icon-transfer-out").remove()},getFreeChampSlot:function(champ){if(champ!=undefined){var slot=this.ui.find('.champion-slot-empty[data-transfer-championid="'+champ.championId+'"]');if(slot.get(0)!=null){return slot}}return this.ui.find(".champion-slot-empty:first")},removeChampions:function(){var slots=this.teamSelection.find(".champion-slot-full"),self=this;slots.each(function(){self.removeChampion($(this).data("champion"),$(this))})},addTransferIcon:function(slot,direction){this.removeTransferIcon(slot);if(direction=="out"){slot.append('<i title="Transfer Out" class="icon-transfer icon-transfer-out"></i>')}else{slot.append('<i title="Transfer In" class="icon-transfer icon-transfer-in"></i>')}},removeTransferIcon:function(slot){slot.find(".icon-transfer").remove()},removeChampion:function(champ,slot){var self=this;if(slot==undefined||slot==null){slot=self.teamSelection.find('.champion-slot-full[data-championid="'+champ.championId+'"]')}if(slot.get(0)!=null){try{self.checkRemoveRestrictions(champ);if(slot.hasClass("champion-transfer")){self.addTransferIcon(slot,"out")}else{for(var x in self.teamPersistedChampions){if(self.teamPersistedChampions[x].championId==champ.championId){slot.addClass("champion-transfer").data("transferOut",champ).attr("data-transfer-championid",champ.championId);self.addTransferIcon(slot,"out");self.team.transfersRemaining--;break}}}self.convertToEmptySlot(slot);self.updateTeamCreditUi();self.enableChampion(champ)}catch(e){self.handleResponseError(e)}}},hasFreeSlot:function(champ){return(this.getFreeChampSlot(champ).get(0)!=null)?true:false},addChampion:function(champ){var self=this,slot=self.getFreeChampSlot(champ);if(slot.get(0)!=null){try{self.checkAddRestrictions(champ);if(slot.hasClass("champion-transfer")){self.removeTransferIcon(slot);if(slot.data("transferOut")!=null&&slot.data("transferOut").championId==champ.championId){champ=slot.data("transferOut");slot.removeClass("champion-transfer").removeAttr("data-transfer-championid").data("transferOut",null);self.team.transfersRemaining++}else{self.addTransferIcon(slot,"in")}}self.convertFromEmptySlot(slot,champ);self.disableChampion(champ);self.updateTeamCreditUi()}catch(e){self.error(e)}}else{self.error("No space available")}},addFreeChampion:function(champ){var self=this;if(!self.hasFreeSlot(champ)){if(parseInt(self.team.credits)-parseInt(champ.championValue)<0){self.error("No space available and insufficient credits")}else{self.beginChampionPurchase(champ)}return}self.setProgress('<div><span><i class="icon-money"></i>'+champ.championValue+'</span>&nbsp;<img src="'+getChampIcon(champ.championName)+'" style="width:32px; height:32px;" /></div><p class="team-maker-popup">Free champions incur a <span style="color:red">-'+Math.floor(self.settings.freeMultiplierPenalty*100)+"%</span> score penalty and are rotated regularly.<br />Add to team anyway?"+((parseInt(self.team.credits)-parseInt(champ.championValue)<0)?"":' or <a title="Purchase" href="#" class="purchase-link">Purchase '+htmlEncode(champ.championName)+"</a>.")+'</p><div><button class="btn btn-add">Add</button>&nbsp;<button class="btn btn-danger">Cancel</button></div>');self.progressModal.find("button.btn-add").one("click",function(){self.hideProgress();if(self.hasFreeSlot(champ)){self.addChampion(champ)}return false});self.progressModal.find("button.btn-danger").one("click",function(){self.hideProgress();return false});self.progressModal.find(".purchase-link").one("click",function(){self.hideProgress();self.beginChampionPurchase(champ);return false})},beginChampionPurchase:function(champ){var self=this;if(parseInt(self.team.credits)-parseInt(champ.championValue)<0){return self.error("Insufficient credits")}self.setProgress('<div><span><i class="icon-money"></i>'+champ.championValue+'</span>&nbsp;<img src="'+getChampIcon(champ.championName)+'" style="width:32px; height:32px;" /></div><p class="team-maker-popup">Purchase <strong>'+htmlEncode(champ.championName)+'</strong>?<br />This cannot be undone.</p><div><button class="btn btn-primary">Purchase</button>&nbsp;<button class="btn btn-danger">Cancel</button></div>');self.progressModal.find("button.btn-primary").one("click",function(){self.hideProgress();self.purchaseChampion(champ)});self.progressModal.find("button.btn-danger").one("click",function(){self.hideProgress()})},purchaseChampion:function(champ){var self=this;self.lockedState=true;self.setProgress('<span class="busy"><img src="'+getChampIcon(champ.championName)+'" style="width:20px; height:20px;" /> Purchasing <strong>'+htmlEncode(champ.championName)+"</strong>...</span>");$.ajax({url:destiny.baseUrl+"Fantasy/Champion/Purchase.json",data:{championId:champ.championId,teamId:self.team.teamId},success:function(response){if(typeof response=="object"&&response.success){self.setProgress('<span><i class="icon-ok icon-white subtle"></i> Purchase successful</span>');self.unlockChampion(champ);self.team.credits=parseInt(self.team.credits)-parseInt(champ.championValue);self.updateTeamCreditUi();self.onsave.call(self,self.team);if(self.hasFreeSlot(champ)){self.addChampion(champ)}window.setTimeout(function(){self.hideProgress();self.lockedState=false},1000)}else{self.handleResponseError(response.message)}},error:function(e){self.handleResponseError(e)}})},checkRemoveRestrictions:function(champ){if(champ.teamId!=undefined&&champ.teamId!=0){if(this.team.transfersRemaining<=0){throw"Insufficient transfers"}}},checkAddRestrictions:function(champ){var self=this;self.ui.find(".champion-slot-full").each(function(){var slotChamp=$(this).data("champion");if(slotChamp!=null&&slotChamp.championId==champ.championId){throw"Champion already in team"}})},disableSelection:function(){this.teamCurrency.addClass("disabled");this.champSelector.addClass("disabled");this.champSearch.attr("disabled","disabled");this.teamSelection.addClass("disabled");this.enabled=false},enableSelection:function(){this.teamCurrency.removeClass("disabled");this.champSelector.removeClass("disabled");this.champSearch.removeAttr("disabled","disabled");this.teamSelection.removeClass("disabled");this.enabled=true},cancelPick:function(){this.hide()},confirmPick:function(){try{this.onconfirm.call(this);this.persistTeam()}catch(e){this.error(e)}},handleResponseError:function(e){var self=this;self.setProgress('<span><i class="icon-remove icon-white subtle"></i> Error: '+e+"</span>");window.setTimeout(function(){self.hideProgress();self.lockedState=false},2000)},persistTeam:function(){var self=this;self.lockedState=true;self.setProgress('<span class="busy"><i class="icon-hdd icon-white subtle"></i> Updating team...</span>');$.ajax({url:destiny.baseUrl+"fantasy/team/update.json",type:"POST",data:{teamId:this.team.teamId,champions:this.getChampionIds().join(",")},success:function(response){if(typeof response!="object"||response.success==false){return self.handleResponseError(response.message)}window.setTimeout(function(){if(response.data!=undefined&&response.data.team!=undefined){self.team=response.data.team;self.updateTeamCreditUi();self.setupChampionSlots(response.data.champions);self.onsave.call(this,response.data.team,response.data.champions)}self.setProgress('<span><i class="icon-ok icon-white subtle"></i> Update successful</span>');window.setTimeout(function(){self.hideProgress();self.lockedState=false;self.hide()},1000)},1000)},error:function(e){self.handleResponseError(e)}})},setProgress:function(html,start,time){DestinyTMI.disableSelection();DestinyTMI.toolsUI.attr("disabled","disabled");DestinyTMI.progressModal.html(html).css({left:((parseInt(DestinyTMI.ui.width())/2)-parseInt(DestinyTMI.progressModal.width())/2)+"px",top:((parseInt(DestinyTMI.ui.height())/2)-parseInt(DestinyTMI.progressModal.height())/2)+"px"}).show();DestinyTMI.innerOverlay.css({width:parseInt(DestinyTMI.ui.width())+"px",height:parseInt(DestinyTMI.ui.height())+"px"}).show()},hideProgress:function(){DestinyTMI.enableSelection();DestinyTMI.progressModal.empty().hide();DestinyTMI.innerOverlay.hide();DestinyTMI.toolsUI.find("button").removeAttr("disabled")}};DestinyTMI.ui=$(".team-maker");DestinyTMI.overlay=$(".team-maker-overlay");DestinyTMI.innerOverlay=$(".team-maker-inner-overlay");DestinyTMI.toolsUI=DestinyTMI.ui.find(".team-maker-tools");DestinyTMI.progressModal=DestinyTMI.ui.find(".team-maker-progress");DestinyTMI.teamSelection=DestinyTMI.ui.find(".team-maker-slots");DestinyTMI.teamCurrency=DestinyTMI.ui.find(".team-maker-currency");DestinyTMI.champSelector=DestinyTMI.ui.find(".team-maker-selection");DestinyTMI.champSearch=DestinyTMI.ui.find('.champ-search input[type="text"]');DestinyTMI.champSearch.typeahead({source:DestinyTMI.champSearch.data("source"),sorter:function(items){DestinyTMI.ui.find(".champion").addClass("hidden");for(var i=0;i<items.length;i++){DestinyTMI.ui.find('.champion[data-name="'+items[i]+'"]').removeClass("hidden")}return items},updater:function(item){DestinyTMI.ui.find(".champion").addClass("hidden");DestinyTMI.ui.find('.champion[data-name="'+item+'"]').removeClass("hidden");return item}});DestinyTMI.ui.find(".champ-sorting .dropdown-menu a").on("click",function(){var sortby=$(this).data("by");if(sortby==""||!sortby){return false}DestinyTMI.champSelector.find(".champion").sortElements(function(a,b){var aV=$(a).data(sortby),bV=$(b).data(sortby);if(aV>bV){return 1}else{if(aV<bV){return -1}else{return 0}}})});DestinyTMI.ui.find(".champ-filter").on("click",function(){if(!$(this).hasClass("active")){$(this).removeClass("btn-inverse");DestinyTMI.ui.addClass("filter-"+$(this).data("filterby"))}else{$(this).addClass("btn-inverse");DestinyTMI.ui.removeClass("filter-"+$(this).data("filterby"))}});DestinyTMI.champSearch.on("keyup",function(){if($(this).val()==""){DestinyTMI.ui.find(".champion").removeClass("hidden")}});DestinyTMI.teamSelection.on("click",".champion-slot-full",function(){if(!DestinyTMI.enabled||DestinyTMI.lockedState){return}DestinyTMI.removeChampion($(this).data("champion"));return false});DestinyTMI.teamSelection.on("click",".champion-slot.champion-transfer.champion-slot-empty",function(){if(!DestinyTMI.enabled||DestinyTMI.lockedState){return}DestinyTMI.addChampion($(this).data("transferOut"));return false});DestinyTMI.champSelector.on("click",".champion",function(){var el=$(this),champion=el.data("champion");if(el.hasClass("disabled")){return false}if(el.hasClass("champion-unlocked")){if(!DestinyTMI.enabled||DestinyTMI.lockedState){return}DestinyTMI.addChampion(champion);return false}if(el.hasClass("champion-free")){if(!DestinyTMI.enabled||DestinyTMI.lockedState){return}DestinyTMI.addFreeChampion(champion);return false}if(el.hasClass("champion-locked")){if(!DestinyTMI.enabled||DestinyTMI.lockedState){return}DestinyTMI.beginChampionPurchase(champion);return false}return false});DestinyTMI.toolsUI.on("click",".btn-close",function(){if(DestinyTMI.lockedState){return}DestinyTMI.cancelPick();return false}).on("click",".btn-confirm",function(){DestinyTMI.confirmPick();return false});DestinyTMI.overlay.on("click",function(){if(DestinyTMI.lockedState){return}DestinyTMI.hide()})})();$(function(){$("form.challengeForm").on("submit",function(){var form=$(this),btn=form.find("button:first"),name=form.find('input[name="name"]');if(name.val().replace(/^\s\s*/,"").replace(/\s\s*$/,"")==""){return false}name.attr("disabled","disabled");btn.text("Sending...");btn.attr("disabled","disabled");name.attr("disabled","disabled");$.ajax({type:"get",data:{name:name.val()},url:destiny.baseUrl+"fantasy/challenge/add",success:function(data){name.removeAttr("disabled");btn.removeAttr("disabled");btn.text(data.message);if(data.success){btn.addClass("btn-success")}else{btn.addClass("btn-danger")}window.setTimeout(function(){btn.text("Challenge!");btn.removeClass("btn-danger");name.val("")},2000)},error:function(){btn.addClass("btn-danger");window.setTimeout(function(){btn.text("Challenge!");btn.removeClass("btn-danger");name.val("")},2000)}});return false});$("#challengeInvites").each(function(){var ui=$(this);ui.find(".invite-accept").on("click",function(){var btn=$(this);if(confirm("Are you sure you want to accept this invite?")){btn.attr("disabled","disabled");$.ajax({type:"get",data:{teamId:btn.data("teamid")},url:destiny.baseUrl+"fantasy/challenge/accept",success:function(data){btn.closest("tr").replaceWith("<tr><td>-</td></tr>")},error:function(){alert("An error occured.");btn.removeAttr("disabled")}})}});ui.find(".invite-decline").on("click",function(){var btn=$(this);if(confirm("Are you sure you want to decline this invite?")){btn.attr("disabled","disabled");$.ajax({type:"get",data:{teamId:btn.data("teamid")},url:destiny.baseUrl+"fantasy/challenge/decline",success:function(data){btn.closest("tr").replaceWith("<tr><td>-</td></tr>")},error:function(){alert("An error occured.");btn.removeAttr("disabled")}})}});ui.find(".sent-invite-delete").on("click",function(){var btn=$(this);if(confirm("Are you sure you want to remove this invite?")){btn.attr("disabled","disabled");$.ajax({type:"get",data:{teamId:btn.data("teamid")},url:destiny.baseUrl+"fantasy/challenge/delete",success:function(data){btn.closest("tr").replaceWith("<tr><td>-</td></tr>")},error:function(){alert("An error occured.");btn.removeAttr("disabled")}})}return false})});$("#challengerGrid").each(function(){var ui=$(this);ui.find(".remove-challenger").on("click",function(){var btn=$(this);if(confirm("Are you sure you want to remove this challenger?")){$.ajax({type:"get",data:{teamId:btn.data("teamid")},url:destiny.baseUrl+"fantasy/challenge/delete",success:function(data){btn.closest("tr").replaceWith("<tr><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td></tr>")},error:function(){alert("An error occured.");btn.removeAttr("disabled")}})}$(this).data("teamid");return false})})});$(function(){new DestinyFeedConsumer({url:destiny.baseUrl+"lastfm.json",polling:40,ifModified:true,start:true,ui:"#stream-lastfm",success:function(data,textStatus){if(textStatus=="notmodified"){return}var entries=$("#stream-lastfm .entries:first").empty();if(data!=null&&typeof data.recenttracks=="object"&&data.recenttracks.track.length>0){for(var i in data.recenttracks.track){if(i==3){break}var track=data.recenttracks.track[i];var entry=$('<div class="media"><a class="pull-left cover-image" href="'+track.url+'"><img class="media-object" src="'+destiny.cdn+'/web/img/64x64.gif" data-src="'+track.image[1]["#text"]+'"></a><div class="media-body"><div class="media-heading trackname"><a title="'+htmlEncode(track.name)+'" href="'+track.url+'">'+htmlEncode(track.name)+'</a></div><div class="artist">'+htmlEncode(track.artist["#text"])+'</div><div class="details">'+((i<3&&track.date_str!="")?'<time class="pull-right" datetime="'+track.date_str+'">'+moment(track.date_str).fromNow()+"</time>":"")+((i==0&&track.date_str=="")?'<time class="pull-right" datetime="'+track.date_str+'">now playing</time>':"")+'<small class="album subtle">'+track.album["#text"]+"</small></div></div></div>");entries.append(entry)}entries.loadImages()}}});new DestinyFeedConsumer({url:destiny.baseUrl+"twitter.json",polling:300,ifModified:true,start:true,ui:"#stream-twitter",success:function(tweets,textStatus){if(textStatus=="notmodified"){return}var entries=$("#stream-twitter .entries:first").empty();for(var i in tweets){if(i==3){break}entries.append('<div class="media"><div class="media-body"><div class="media-heading"><a target="_blank" href="https://twitter.com/'+tweets[i].user.screen_name+"/status/"+tweets[i].id_str+'"><i class="icon-share icon-white subtle"></i></a> '+tweets[i].html+'</div><time datetime="'+tweets[i].created_at+'" pubdate>'+moment(tweets[i].created_at).fromNow()+"</time></div></div>")}entries.loadImages()}});new DestinyFeedConsumer({url:destiny.baseUrl+"youtube.json",ifModified:true,start:true,ui:"#youtube",success:function(data,textStatus){if(textStatus=="notmodified"){return}var ui=$("#youtube .thumbnails:first").empty();ui.removeClass("thumbnails-loading");if(typeof data=="object"){for(var i in data.items){var title=htmlEncode(data.items[i].snippet.title);ui.append('<li><div class="thumbnail" rel="tooltip" title="'+title+'"><a href="http://www.youtube.com/watch?v='+data.items[i].snippet.resourceId.videoId+'"><img alt="'+title+'" src="'+destiny.cdn+'/web/img/320x240.gif" data-src="https://i.ytimg.com/vi/'+data.items[i].snippet.resourceId.videoId+'/default.jpg" /></a></div></li>');ui.find(".thumbnail").tooltip({placement:"bottom"})}ui.loadImages()}}});new DestinyFeedConsumer({url:destiny.baseUrl+"broadcasts.json",polling:600,ifModified:true,start:true,ui:"#broadcasts",success:function(data,textStatus){if(textStatus=="notmodified"){return}var broadcasts=$("#broadcasts"),ui=broadcasts.find(".thumbnails:first").empty();ui.removeClass("thumbnails-loading");if(data!=null&&typeof data.videos!=undefined){for(var i in data.videos){var time=moment(data.videos[i].recorded_at).fromNow();ui.append('<li><div class="thumbnail" data-placement="bottom" rel="tooltip" title="'+time+'"><a href="'+data.videos[i].url+'"><img alt="'+time+'" src="'+destiny.cdn+'/web/img/320x240.gif" data-src="'+data.videos[i].preview+'"></a></div></li>')}ui.loadImages();ui.find('[rel="tooltip"]').tooltip()}}});new DestinyFeedConsumer({url:destiny.baseUrl+"stream.json",polling:30,ifModified:true,start:false,ui:"#twitchpanel",success:function(data,textStatus){if(textStatus=="notmodified"){return}var ui=$("#twitchpanel .panelheader .game");if(data!=null&&data.stream!=null){ui.html('<i class="icon-time icon-white subtle"></i> <span>Started '+moment(data.stream.channel.updated_at).fromNow()+"</span>"+((data.stream.channel.delay>0)?" - "+parseInt((data.stream.channel.delay/60))+"m delay":"")).show();$("#twitchpanel").removeClass("offline").addClass("online")}else{try{ui.html('<i class="icon-time icon-white subtle"></i> <span>Last broadcast ended '+moment(data.lastbroadcast).fromNow()+"</span>").show()}catch(e){ui.html('<i class="icon-time icon-white subtle"></i> <span>Broadcast has ended</span>').show()}$("#twitchpanel").removeClass("online").addClass("offline")}}});new DestinyFeedConsumer({url:destiny.baseUrl+"summoners.json",polling:70,ifModified:true,start:false,ui:"#lolpanel",success:function(summoners,textStatus){if(textStatus=="notmodified"){return}var panel=$("#lolpanel");if(typeof summoners!="object"||summoners==null||summoners.length==0){panel.hide();return}panel.find(".content:first").empty();for(var i=0;i<summoners.length;++i){var summoner=summoners[i],ui=$('<div id="summoner-'+summoner.summonerId+'" class="summoner-stub clearfix" />');ui.append('<div class="summoner-info pull-left"><div class="summoner-info-stub pull-left"><h3 class="summoner-title">'+htmlEncode(summoner.name)+' <small><a title="LOLKING profile" href="http://www.lolking.net/summoner/'+summoner.region.id+"/"+summoner.summonerId+'">lolking.com</a></small> </h3><span class="summoner-region">'+summoner.region.label+((summoner.summonerLevel==undefined)?"":" - Level "+summoner.summonerLevel)+((summoner.league==null)?"":" - Elo "+summoner.league.approximateElo)+"</span></div></div>");if(summoner.league==null){ui.append('<div class="summoner-rank-info unranked pull-right"><div class="pull-left summon-rank-display"><div class="summoner-rank unranked pull-left" style="">Unknown</div><div class="summoner-rank-thumbnail pull-left"><i title="Unknown" style="width:45px; height:45px; background: url('+destiny.cdn+'/web/img/lol/rank/unknown.png) no-repeat center center; background-size: 60px 60px;"></i></div></div></div>')}else{var miniSeries=(summoner.league.miniSeries!=undefined)?summoner.league.miniSeries:null;var position=summoner.league.position,positionOffset=position-summoner.league.previousDayLeaguePosition;ui.append('<div class="summoner-rank-info ranked pull-right">'+((miniSeries==null)?"":'<div class="pull-left summon-rank-stats summon-mini-series"><div><span style="color: #b19e00;">'+miniSeries.target+'</span> game series</div><div><span style="color: #1a6f00;">'+miniSeries.wins+'</span> / <span style="color: #8a1919;">'+miniSeries.losses+"</span> Win Loss</div></div>")+'<div class="pull-left summon-rank-stats"><div>'+htmlEncode(summoner.league.leagueName)+'</div><div><span data-placement="left" rel="tooltip" title="Previous day position '+summoner.league.previousDayLeaguePosition+'">Position <i class="icon-arrow-'+((positionOffset>0)?"down":"up")+' icon-white"></i></span><span data-placement="left" rel="tooltip" title="Out of '+(summoner.league.totalEntries)+'" style="color: #'+((positionOffset>0)?"8a1919":"1a6f00")+';">'+(position)+"</span>"+((summoner.league.hotStreak==false)?"":' <i data-placement="left" rel="tooltip" class="icon-fire icon-white" title="HOOOOOTTT STTTRRREEEAAAAAKKKKKK!"></i> ')+((summoner.league.freshBlood==false)?"":' <i data-placement="left" rel="tooltip" class="icon-tint icon-white" title="Fresh Meat!"></i> ')+'</div></div><div class="pull-left summon-rank-stats"><div><span style="color: #b19e00;">'+summoner.league.leaguePoints+'</span> League Points</div><div><span style="color: #1a6f00;">'+summoner.league.wins+'</span> / <span style="color: #8a1919;">'+summoner.league.losses+'</span> Win Loss</div></div><div class="pull-left summon-rank-display"><div class="summoner-rank ranked pull-left"><span style="text-transform: capitalize;">'+summoner.league.tier.toLowerCase()+"</span> "+summoner.league.rank+'</div><div class="summoner-rank-thumbnail pull-left"><i data-placement="left" rel="tooltip" title="'+summoner.league.tier+" "+summoner.league.rank+'" style="width:45px; height:45px; background: url('+destiny.cdn+"/web/img/lol/rank/"+summoner.league.tier.toLowerCase()+"_"+summoner.league.rankInt+'.png) no-repeat center center; background-size: 60px 60px;"></i></div></div></div>')}panel.find(".content:first").append(ui)}panel.loadImages();panel.find('[rel="tooltip"]').tooltip()}});(function(){var currentIngameId=$("#activeGame").data("gameid");new DestinyFeedConsumer({url:destiny.baseUrl+"fantasy/ingame.json",polling:30,ifModified:true,start:false,ui:"#newInGameAlert",data:{},success:function(game,textStatus){if(textStatus=="notmodified"){return}if(game!=null&&game.gameId!=null){if(game.gameId!=currentIngameId){$("#newInGameAlert:hidden").fadeIn();$("#activeGame:visible").fadeOut()}else{$("#newInGameAlert:visible").fadeOut();$("#activeGame:hidden").fadeIn()}}else{$("#activeGame:visible").fadeOut()}}});var lastChecked=new Date();new DestinyFeedConsumer({url:destiny.baseUrl+"Fantasy/Recentgames.json",polling:30,ifModified:true,start:false,ui:"#newGameAlert",success:function(data,textStatus){var aggregateDate=(data!=null)?new Date(data.date):null;if(textStatus!="notmodified"&&aggregateDate!=null&&aggregateDate>lastChecked){$("#newGameAlert:hidden").fadeIn()}}})})();var pads=$(".private-ads .private-ad"),adRotateIndex=pads.length-1;setInterval(function(){$(pads[adRotateIndex]).fadeOut(500,function(){$(this).hide().removeClass("active")});if(adRotateIndex<pads.length-1){adRotateIndex++}else{adRotateIndex=0}$(pads[adRotateIndex]).hide().addClass("active").fadeIn(500)},6*1000);var gad=$("#google-ad");setTimeout(function(){if(gad.css("display")=="none"||parseInt(gad.height())<=0){gad.before('<div id="adblocker-message"><a>Add blocker</a><p>Please consider turning adblocker off for this website.</p></div>')}},8000);$('.nav a[rel="signout"]').click(function(){if(confirm("Are you sure?")){window.location.href=destiny.baseUrl+"Logout"}});(function(){var timezone=moment().format("ZZ"),calendarFrame=$("#scheduleCalendar"),iframe=calendarFrame.find("iframe"),tzNote=$("#scheduleCalendarTimezone"),timezoneSelect=tzNote.find("select"),timezoneBtn=tzNote.find("button.change-timezone"),timezoneLbl=tzNote.find("span.timezone");var loadGoogleCalendar=function(){iframe.attr("src",iframe.data("src")+"&ctz="+encodeURIComponent(timezone));timezoneLbl.html(timezone)};timezoneBtn.on("click",function(){$("#scheduleCalendarForm").toggle("hide")});timezoneSelect.on("change",function(){timezone=timezoneSelect.val();loadGoogleCalendar();return false});loadGoogleCalendar()})();(function(){var subscriptionsUi=$("#subscriptions");subscriptionsUi.on("click",".subscription:not(.active)",function(e){subscriptionsUi.find(".subscription.active").each(function(){$(this).removeClass("active")});$(this).find('input[name="subscription"]').prop("checked",true);$(this).find('.payment-options input[type="radio"]:first').prop("checked",true);$(this).addClass("active")})})();$("body#bigscreen").each(function(){var offset=81,pc=$(".page-content");var _resize=function(){var bh=$("body").height();pc.height(((bh<550)?550:bh)-offset);pc.find("#twitch-chat-wrap .twitch-element").height(pc.height()-20);pc.find("#twitch-stream-wrap .twitch-element").height(pc.height()-20-30)};$(window).on("resize",_resize);_resize();new DestinyFeedConsumer({url:destiny.baseUrl+"stream.json",polling:30,ui:"#twitch-stream-wrap .panelheader .game",ifModified:true,success:function(data,textStatus){if(textStatus=="notmodified"){return}var ui=$("#twitch-stream-wrap .panelheader .game");if(data!=null&&data.stream!=null){ui.html('<i class="icon-time icon-white subtle"></i> <span>Started '+moment(data.stream.channel.updated_at).fromNow()+"</span>"+((data.stream.channel.delay>0)?" - "+parseInt((data.stream.channel.delay/60))+"m delay":"")).show();return}try{ui.html('<i class="icon-time icon-white subtle"></i> <span>Last broadcast ended '+moment(data.lastbroadcast).fromNow()+"</span>").show()}catch(e){ui.html('<i class="icon-time icon-white subtle"></i> <span>Broadcast has ended</span>').show()}}})});$("form .refresh-captcha").click(function(){var img=$(this).prev(),src=img.attr("src");img.removeAttr("str").attr("src",src);return false});$(".collapse").collapse();if(location.hash!==""){$('a[href="'+location.hash+'"]').tab("show")}$("body").each(function(){$('.navbar a[rel="'+$("body").attr("id")+'"]').closest("li").addClass("active");$('.navbar a[rel="'+$("body").attr("class")+'"]').closest("li").addClass("active")});$(this).loadImages();$(this).find('[rel="tooltip"]').tooltip()});(function(){var applMomentTime=function(){$('time[data-moment="true"]:not(.moment-set)').each(function(){var ui=$(this),datetime=ui.data("datetime")||ui.attr("datetime")||ui.text();ui.data("datetime",datetime);if(ui.data("moment-fromnow")){ui.html(moment(datetime).fromNow())}else{ui.addClass("moment-set");ui.html(moment(datetime).format("MMMM Do, h:mm:ss a"))}})};window.setInterval(applMomentTime,30000);applMomentTime()})();(function(){window.setInterval(function(){$.ajax({url:"/ping",method:"get"})},10*60*1000)})();(function(){$.cookie.json=true;$(".alert .close.persist").each(function(){var parent=$(this).parent(".alert"),id=parent.attr("id");if(!id){return}id="alert-dismissed-"+id;$(this).click(function(){$.cookie(id,true,{expires:365})});if($.cookie(id)){parent.remove()}})})();