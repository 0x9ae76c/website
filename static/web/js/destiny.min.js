function htmlEncode(value){return String(value).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}function getRandomInt(min,max){return Math.floor(Math.random()*(max-min+1))+min}$.fn.loadImages=function(options){return options=$.extend({},{attr:"src"},options),this.find("img[data-"+options.attr+"]").each(function(){var img=$(this),url=img.data(options.attr);if(""!=url&&null!=url){var nimg=img.clone();nimg.one("load",function(){img.replaceWith(nimg)}),nimg.removeAttr(options.attr).removeAttr("data-"+options.attr).attr("src",url)}})},$.fn.sortElements=function(){var sort=[].sort;return function(comparator,getSortable){getSortable=getSortable||function(){return this};var placements=this.map(function(){var sortElement=getSortable.call(this),parentNode=sortElement.parentNode,nextSibling=parentNode.insertBefore(document.createTextNode(""),sortElement.nextSibling);return function(){if(parentNode===this)throw new Error("You can't sort elements if any one is a descendant of another.");parentNode.insertBefore(this,nextSibling),parentNode.removeChild(nextSibling)}});return sort.call(this,comparator).each(function(i){placements[i].call(getSortable.call(this))})}}(),String.prototype.trim=function(){return $.trim(this)},String.prototype.format||(String.prototype.format=function(){var args=arguments;return this.replace(/{(\d+)}/g,function(match,number){return"undefined"!=typeof args[number]?args[number]:match})}),destiny={cdn:"",token:"",baseUrl:"/",timeout:15e3,fn:{}},destiny.init=function(args){$.extend(destiny,args)},function($){var DestinyFeedConsumer=function(args){return this.args=$.extend({polling:null,init:$.noop(),success:$.noop(),error:$.noop(),pollexecute:$.noop(),type:"GET",dataType:"json",start:!0,ui:null},args),this.init()};$.extend(DestinyFeedConsumer.prototype,{polling:null,args:null,init:function(){if($.isFunction(this.args.init)&&this.args.init.call(this,this.args),null!=this.args.ui){if(null==$(this.args.ui).get(0))return;null!=$(this.args.ui).find(".loading").get(0)&&(this.args.start=!0)}return this.args.start&&this.load(),this.args.start=!0,this.setupPoll(),this},load:function(){return $.ajax(this.args),this},setupPoll:function(){var self=this;null!=self.polling&&self.stopPolling(),null!=self.args.polling&&"number"==typeof self.args.polling&&(self.polling=setInterval(function(){$.isFunction(self.args.pollexecute)&&!1===self.args.pollexecute.call(self,self.args)||self.load()},1e3*self.args.polling))},stopPolling:function(){clearInterval(this.polling)},resetPoll:function(){this.setupPoll()}}),window.DestinyFeedConsumer=DestinyFeedConsumer}(jQuery),$(function(){var twitch=$("#twitchpanel"),twitchElements=$("#twitch-elements"),chat=twitchElements.find("#chat-embed"),player=twitchElements.find("#player-embed"),popoutChatBtn=twitch.find("#popoutchat"),popoutVideoBtn=twitch.find("#popoutvideo"),playerWrap=$("div.twitch-element-wrap"),fullscreenBtn=playerWrap.find("div.twitch-fsbtn"),playerOverlays=playerWrap.find("div.twitch-overlay"),twitchChat={popup:null,toggle:function(){null==this.popup?this.popOut():this.popIn()},popOut:function(){popoutChatBtn.attr("title","Re-embed chat").addClass("btn-down"),twitchElements.children().length<=1?twitch.removeClass("split-view single-view").addClass("no-view"):twitch.removeClass("split-view").addClass("single-view"),chat.detach(),this.popup=window.open(twitch.data("chat-embed"),"_blank","height=500,width=420,scrollbars=0,toolbar=0,location=0,status=no,menubar=0,resizable=0,dependent=0")},popIn:function(){popoutChatBtn.attr("title","Pop-out chat").removeClass("btn-down"),twitchElements.children().length<=0?twitch.removeClass("split-view").addClass("single-view"):twitch.addClass("split-view").removeClass("single-view"),null!=this.popup&&(this.popup.close(),this.popup=null),chat.appendTo(twitchElements)}},twitchVideo={popup:null,toggle:function(){null==this.popup?this.popOut():this.popIn()},popOut:function(){popoutVideoBtn.attr("title","Re-embed video").addClass("btn-down"),twitchElements.children().length<=1?twitch.removeClass("split-view single-view").addClass("no-view"):twitch.removeClass("split-view").addClass("single-view"),player.detach(),this.popup=window.open(twitch.data("video-embed"),"_blank","height=420,width=720,scrollbars=0,toolbar=0,location=0,status=no,menubar=0,resizable=1,dependent=0")},popIn:function(){popoutVideoBtn.attr("title","Pop-out video").removeClass("btn-down"),twitchElements.children().length<=0?twitch.removeClass("split-view").addClass("single-view"):twitch.addClass("split-view").removeClass("single-view"),null!=this.popup&&(this.popup.close(),this.popup=null),player.prependTo(twitchElements)}};popoutChatBtn.on("click",function(){twitchChat.toggle()}),popoutVideoBtn.on("click",function(){twitchVideo.toggle()});var fullscreenFn=function(fn,elem){for(var agents=["webkit","moz","ms","o",""],i=agents.length-1;i>=0;i--){var agent=agents[i],fullFn=null;if(fullFn=agent?agent+fn:fn.substr(0,1).toLowerCase()+fn.substr(1),"function"==typeof elem[fullFn]){elem[fullFn]();break}}},toggleFullscreen=function(e){e.preventDefault(),document.fullscreen||document.mozFullScreen||document.webkitIsFullScreen?fullscreenFn("CancelFullScreen",document):fullscreenFn("RequestFullScreen",playerWrap.get(0))};fullscreenBtn.click(toggleFullscreen),playerOverlays.dblclick(toggleFullscreen)}),$(function(){new DestinyFeedConsumer({url:destiny.baseUrl+"lastfm.json",polling:40,ifModified:!0,start:!0,ui:"#stream-lastfm",success:function(data,textStatus){if("notmodified"!=textStatus){var entries=$("#stream-lastfm .entries:first").empty();if(null!=data&&"object"==typeof data.recenttracks&&data.recenttracks.track.length>0){for(var i in data.recenttracks.track){if(3==i)break;var track=data.recenttracks.track[i],entry=$('<div class="media"><a class="pull-left cover-image" href="'+track.url+'"><img class="media-object" src="'+destiny.cdn+'/web/img/64x64.gif" data-src="'+track.image[1]["#text"]+'"></a><div class="media-body"><div class="media-heading trackname"><a title="'+htmlEncode(track.name)+'" href="'+track.url+'">'+htmlEncode(track.name)+'</a></div><div class="artist">'+htmlEncode(track.artist["#text"])+'</div><div class="details">'+(3>i&&""!=track.date_str?'<time class="pull-right" datetime="'+track.date_str+'">'+moment(track.date_str).fromNow()+"</time>":"")+(0==i&&""==track.date_str?'<time class="pull-right" datetime="'+track.date_str+'">now playing</time>':"")+'<small class="album subtle">'+track.album["#text"]+"</small></div></div></div>");entries.append(entry)}entries.loadImages()}}}}),new DestinyFeedConsumer({url:destiny.baseUrl+"twitter.json",polling:300,ifModified:!0,start:!0,ui:"#stream-twitter",success:function(tweets,textStatus){if("notmodified"!=textStatus){var entries=$("#stream-twitter .entries:first").empty();for(var i in tweets){if(3==i)break;entries.append('<div class="media"><div class="media-body"><div class="media-heading"><a target="_blank" href="https://twitter.com/'+tweets[i].user.screen_name+"/status/"+tweets[i].id_str+'"><i class="icon-share icon-white subtle"></i></a> '+tweets[i].html+'</div><time datetime="'+tweets[i].created_at+'" pubdate>'+moment(tweets[i].created_at).fromNow()+"</time></div></div>")}entries.loadImages()}}}),new DestinyFeedConsumer({url:destiny.baseUrl+"youtube.json",ifModified:!0,start:!0,ui:"#youtube",success:function(data,textStatus){if("notmodified"!=textStatus){var ui=$("#youtube .thumbnails:first").empty();if(ui.removeClass("thumbnails-loading"),"object"==typeof data){for(var i in data.items){var title=htmlEncode(data.items[i].snippet.title);ui.append('<li><div class="thumbnail" data-toggle="tooltip" title="'+title+'"><a href="http://www.youtube.com/watch?v='+data.items[i].snippet.resourceId.videoId+'"><img alt="'+title+'" src="'+destiny.cdn+'/web/img/320x240.gif" data-src="https://i.ytimg.com/vi/'+data.items[i].snippet.resourceId.videoId+'/default.jpg" /></a></div></li>'),ui.find(".thumbnail").tooltip({placement:"bottom"})}ui.loadImages()}}}}),new DestinyFeedConsumer({url:destiny.baseUrl+"broadcasts.json",polling:600,ifModified:!0,start:!0,ui:"#broadcasts",success:function(data,textStatus){if("notmodified"!=textStatus){var broadcasts=$("#broadcasts"),ui=broadcasts.find(".thumbnails:first").empty();if(ui.removeClass("thumbnails-loading"),null!=data&&void 0!=typeof data.videos){for(var i in data.videos){var time=moment(data.videos[i].recorded_at).fromNow();ui.append('<li><div class="thumbnail" data-placement="bottom" rel="tooltip" title="'+time+'"><a href="'+data.videos[i].url+'"><img alt="'+time+'" src="'+destiny.cdn+'/web/img/320x240.gif" data-src="'+data.videos[i].preview+'"></a></div></li>')}ui.loadImages(),ui.find('[data-toggle="tooltip"]').tooltip()}}}}),new DestinyFeedConsumer({url:destiny.baseUrl+"stream.json",polling:30,ifModified:!0,start:!1,ui:"#twitchpanel",success:function(data,textStatus){if("notmodified"!=textStatus){var ui=$("#twitchpanel .panelheader .game");if(null!=data&&null!=data.stream)ui.html('<i class="icon-time icon-white subtle"></i> <span>Started '+moment(data.stream.channel.updated_at).fromNow()+"</span>"+(data.stream.channel.delay>0?" - "+parseInt(data.stream.channel.delay/60)+"m delay":"")).show(),$("#twitchpanel").removeClass("offline").addClass("online");else{try{ui.html('<i class="icon-time icon-white subtle"></i> <span>Last broadcast ended '+moment(data.lastbroadcast).fromNow()+"</span>").show()}catch(e){ui.html('<i class="icon-time icon-white subtle"></i> <span>Broadcast has ended</span>').show()}$("#twitchpanel").removeClass("online").addClass("offline")}}}});var pads=$(".private-ads .private-ad"),adRotateIndex=pads.length-1;setInterval(function(){$(pads[adRotateIndex]).fadeOut(500,function(){$(this).hide().removeClass("active")}),adRotateIndex<pads.length-1?adRotateIndex++:adRotateIndex=0,$(pads[adRotateIndex]).hide().addClass("active").fadeIn(500)},8e3);var gad=$("#google-ad");setTimeout(function(){("none"==gad.css("display")||parseInt(gad.height())<=0)&&gad.before('<div id="adblocker-message"><a>Add blocker</a><p>Please consider turning adblocker off for this website.</p></div>')},8e3),$('.nav a[rel="signout"]').click(function(){confirm("Are you sure?")&&(window.location.href=destiny.baseUrl+"Logout")}),function(){var timezone=moment().format("ZZ"),calendarFrame=$("#scheduleCalendar iframe"),tzNote=$("#scheduleCalendarTimezone"),timezoneSelect=tzNote.find("select"),timezoneBtn=tzNote.find("button.change-timezone"),timezoneLbl=tzNote.find("span.timezone"),loadGoogleCalendar=function(){calendarFrame.attr("src",calendarFrame.data("src")+"&ctz="+encodeURIComponent(timezone)),timezoneLbl.html(timezone)};timezoneBtn.on("click",function(){$("#scheduleCalendarForm").toggle("hide")}),timezoneSelect.on("change",function(){return timezone=timezoneSelect.val(),loadGoogleCalendar(),!1}),loadGoogleCalendar()}(),$("body#bigscreen").each(function(){var offset=81,pc=$(".page-content"),_resize=function(){var bh=$("body").height();pc.height((550>bh?550:bh)-offset),pc.find("#chat-panel .twitch-element").height(pc.height()-20),document.fullscreen||document.mozFullScreen||document.webkitIsFullScreen?pc.find("#twitch-stream-wrap .twitch-element").height("100%"):pc.find("#twitch-stream-wrap .twitch-element").height(pc.height()-20-30)};$(window).on("resize",_resize),_resize(),new DestinyFeedConsumer({url:destiny.baseUrl+"stream.json",polling:30,ui:"#twitch-stream-wrap .panelheader .game",ifModified:!0,success:function(data,textStatus){if("notmodified"!=textStatus){var ui=$("#twitch-stream-wrap .panelheader .game");if(null!=data&&null!=data.stream)return ui.html('<i class="icon-time icon-white subtle"></i> <span>Started '+moment(data.stream.channel.updated_at).fromNow()+"</span>"+(data.stream.channel.delay>0?" - "+parseInt(data.stream.channel.delay/60)+"m delay":"")).show(),void 0;try{ui.html('<i class="icon-time icon-white subtle"></i> <span>Last broadcast ended '+moment(data.lastbroadcast).fromNow()+"</span>").show()}catch(e){ui.html('<i class="icon-time icon-white subtle"></i> <span>Broadcast has ended</span>').show()}}}})}),$("form .refresh-captcha").click(function(){var img=$(this).prev(),src=img.attr("src");return img.removeAttr("str").attr("src",src),!1}),$(".collapse").collapse(),""!==location.hash&&$('a[href="'+location.hash+'"]').tab("show"),$("body").each(function(){$('.navbar a[rel="'+$("body").attr("id")+'"]').closest("li").addClass("active"),$('.navbar a[rel="'+$("body").attr("class")+'"]').closest("li").addClass("active")}),$(this).loadImages(),$(this).find('[data-toggle="tooltip"]').tooltip()}),function(){var applyMomentToElement=function(e){var ui=$(e),datetime=ui.data("datetime")||ui.attr("datetime")||ui.text(),format=ui.data("format")||"MMMM Do, h:mm:ss a";ui.data("moment-fromnow")?(ui.addClass("moment-update"),ui.html(moment(datetime).fromNow())):ui.html(moment(datetime).format(format)),ui.data("datetime",datetime).addClass("moment-set")};window.setInterval(function(){$("time.moment-update").each(function(){applyMomentToElement(this)})},3e4),$('time[data-moment="true"]:not(.moment-set)').each(function(){applyMomentToElement(this)})}(),function(){window.setInterval(function(){$.ajax({url:"/ping",method:"get"})},6e5)}(),function(){$.cookie.json=!0,$(".alert .close.persist").each(function(){var parent=$(this).parent(".alert"),id=parent.attr("id");id&&(id="alert-dismissed-"+id,$(this).click(function(){$.cookie(id,!0,{expires:365})}),$.cookie(id)&&parent.remove())})}();
//# sourceMappingURL=destiny.min.map