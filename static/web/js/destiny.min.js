function htmlEncode(value){return String(value).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}$.fn.loadImages=function(options){options=$.extend({},{attr:"src"},options);return this.find("img[data-"+options.attr+"]").each(function(){var img=$(this),url=img.data(options.attr);if(url!=""&&url!=null){var nimg=img.clone();nimg.one("load",function(){img.replaceWith(nimg)});nimg.removeAttr(options.attr).removeAttr("data-"+options.attr).attr("src",url)}})};$.fn.sortElements=(function(){var sort=[].sort;return function(comparator,getSortable){getSortable=getSortable||function(){return this};var placements=this.map(function(){var sortElement=getSortable.call(this),parentNode=sortElement.parentNode;var nextSibling=parentNode.insertBefore(document.createTextNode(""),sortElement.nextSibling);return function(){if(parentNode===this){throw new Error("You can't sort elements if any one is a descendant of another.")}parentNode.insertBefore(this,nextSibling);parentNode.removeChild(nextSibling)}});return sort.call(this,comparator).each(function(i){placements[i].call(getSortable.call(this))})}})();function getRandomInt(min,max){return Math.floor(Math.random()*(max-min+1))+min}String.prototype.trim=function(){return $.trim(this)};if(!String.prototype.format){String.prototype.format=function(){var args=arguments;return this.replace(/{(\d+)}/g,function(match,number){return typeof args[number]!="undefined"?args[number]:match})}}destiny={cdn:"",token:"",baseUrl:"/",timeout:15000,fn:{}};destiny.init=function(args){$.extend(destiny,args)};(function($){var DestinyFeedConsumer=function(args){this.args=$.extend({polling:null,init:$.noop(),success:$.noop(),error:$.noop(),pollexecute:$.noop(),type:"GET",dataType:"json",start:true,ui:null,},args);return this.init()};$.extend(DestinyFeedConsumer.prototype,{polling:null,args:null,init:function(){if($.isFunction(this.args.init)){this.args.init.call(this,this.args)}if(this.args.ui!=null){if($(this.args.ui).get(0)==null){return}if($(this.args.ui).find(".loading").get(0)!=null){this.args.start=true}}if(this.args.start){this.load()}this.args.start=true;this.setupPoll();return this},load:function(){$.ajax(this.args);return this},setupPoll:function(){var self=this;if(self.polling!=null){self.stopPolling()}if(self.args.polling!=null&&typeof self.args.polling=="number"){self.polling=setInterval(function(){if($.isFunction(self.args.pollexecute)&&false===self.args.pollexecute.call(self,self.args)){return}self.load()},self.args.polling*1000)}},stopPolling:function(){clearInterval(this.polling)},resetPoll:function(){this.setupPoll()}});window.DestinyFeedConsumer=DestinyFeedConsumer})(jQuery);$(function(){var twitch=$("#twitchpanel"),twitchElements=$("#twitch-elements"),chat=twitchElements.find("#chat-embed"),player=twitchElements.find("#player-embed"),popoutChatBtn=twitch.find("#popoutchat"),popoutVideoBtn=twitch.find("#popoutvideo"),bigscreenmodeBtn=twitch.find("#bigscreenmode");var playerWrap=$("div.twitch-element-wrap"),fullscreenBtn=playerWrap.find("div.twitch-fsbtn"),playerOverlays=playerWrap.find("div.twitch-overlay");var twitchChat={popup:null,toggle:function(){if(this.popup==null){this.popOut()}else{this.popIn()}},popOut:function(){popoutChatBtn.attr("title","Re-embed chat").addClass("btn-down");if(twitchElements.children().length<=1){twitch.removeClass("split-view single-view").addClass("no-view")}else{twitch.removeClass("split-view").addClass("single-view")}chat.detach();this.popup=window.open(twitch.data("chat-embed"),"_blank","height=500,width=420,scrollbars=0,toolbar=0,location=0,status=no,menubar=0,resizable=0,dependent=0")},popIn:function(){popoutChatBtn.attr("title","Pop-out chat").removeClass("btn-down");if(twitchElements.children().length<=0){twitch.removeClass("split-view").addClass("single-view")}else{twitch.addClass("split-view").removeClass("single-view")}if(this.popup!=null){this.popup.close();this.popup=null}chat.appendTo(twitchElements)}};var twitchVideo={popup:null,toggle:function(){if(this.popup==null){this.popOut()}else{this.popIn()}},popOut:function(){popoutVideoBtn.attr("title","Re-embed video").addClass("btn-down");if(twitchElements.children().length<=1){twitch.removeClass("split-view single-view").addClass("no-view")}else{twitch.removeClass("split-view").addClass("single-view")}player.detach();this.popup=window.open(twitch.data("video-embed"),"_blank","height=420,width=720,scrollbars=0,toolbar=0,location=0,status=no,menubar=0,resizable=1,dependent=0")},popIn:function(){popoutVideoBtn.attr("title","Pop-out video").removeClass("btn-down");if(twitchElements.children().length<=0){twitch.removeClass("split-view").addClass("single-view")}else{twitch.addClass("split-view").removeClass("single-view")}if(this.popup!=null){this.popup.close();this.popup=null}player.prependTo(twitchElements)}};popoutChatBtn.on("click",function(){twitchChat.toggle()});popoutVideoBtn.on("click",function(){twitchVideo.toggle()});bigscreenmodeBtn.on("click",function(){var nw=window.open("/bigscreen","bigscreen");var tw=twitch.detach();$(nw).on("beforeunload",function(){$("#header-band").after(tw)});return false});var fullscreenFn=function(fn,elem){var agents=["webkit","moz","ms","o",""];for(var i=agents.length-1;i>=0;i--){var agent=agents[i],fullFn=null;if(!agent){fullFn=fn.substr(0,1).toLowerCase()+fn.substr(1)}else{fullFn=agent+fn}if(typeof elem[fullFn]!="function"){continue}elem[fullFn]();break}};var toggleFullscreen=function(e){e.preventDefault();if(document.fullscreen||document.mozFullScreen||document.webkitIsFullScreen){fullscreenFn("CancelFullScreen",document)}else{fullscreenFn("RequestFullScreen",playerWrap.get(0))}};fullscreenBtn.click(toggleFullscreen);playerOverlays.dblclick(toggleFullscreen)});$(function(){new DestinyFeedConsumer({url:destiny.baseUrl+"lastfm.json",polling:40,ifModified:true,start:true,ui:"#stream-lastfm",success:function(data,textStatus){if(textStatus=="notmodified"){return}var entries=$("#stream-lastfm .entries:first").empty();if(data!=null&&typeof data.recenttracks=="object"&&data.recenttracks.track.length>0){for(var i in data.recenttracks.track){if(i==3){break}var track=data.recenttracks.track[i];var entry=$('<div class="media"><a class="pull-left cover-image" href="'+track.url+'"><img class="media-object" src="'+destiny.cdn+'/web/img/64x64.gif" data-src="'+track.image[1]["#text"]+'"></a><div class="media-body"><div class="media-heading trackname"><a title="'+htmlEncode(track.name)+'" href="'+track.url+'">'+htmlEncode(track.name)+'</a></div><div class="artist">'+htmlEncode(track.artist["#text"])+'</div><div class="details">'+((i<3&&track.date_str!="")?'<time class="pull-right" datetime="'+track.date_str+'">'+moment(track.date_str).fromNow()+"</time>":"")+((i==0&&track.date_str=="")?'<time class="pull-right" datetime="'+track.date_str+'">now playing</time>':"")+'<small class="album subtle">'+track.album["#text"]+"</small></div></div></div>");entries.append(entry)}entries.loadImages()}}});new DestinyFeedConsumer({url:destiny.baseUrl+"twitter.json",polling:300,ifModified:true,start:true,ui:"#stream-twitter",success:function(tweets,textStatus){if(textStatus=="notmodified"){return}var entries=$("#stream-twitter .entries:first").empty();for(var i in tweets){if(i==3){break}entries.append('<div class="media"><div class="media-body"><div class="media-heading"><a target="_blank" href="https://twitter.com/'+tweets[i].user.screen_name+"/status/"+tweets[i].id_str+'"><i class="icon-share icon-white subtle"></i></a> '+tweets[i].html+'</div><time datetime="'+tweets[i].created_at+'" pubdate>'+moment(tweets[i].created_at).fromNow()+"</time></div></div>")}entries.loadImages()}});new DestinyFeedConsumer({url:destiny.baseUrl+"youtube.json",ifModified:true,start:true,ui:"#youtube",success:function(data,textStatus){if(textStatus=="notmodified"){return}var ui=$("#youtube .thumbnails:first").empty();ui.removeClass("thumbnails-loading");if(typeof data=="object"){for(var i in data.items){var title=htmlEncode(data.items[i].snippet.title);ui.append('<li><div class="thumbnail" data-toggle="tooltip" title="'+title+'"><a href="http://www.youtube.com/watch?v='+data.items[i].snippet.resourceId.videoId+'"><img alt="'+title+'" src="'+destiny.cdn+'/web/img/320x240.gif" data-src="https://i.ytimg.com/vi/'+data.items[i].snippet.resourceId.videoId+'/default.jpg" /></a></div></li>');ui.find(".thumbnail").tooltip({placement:"bottom"})}ui.loadImages()}}});new DestinyFeedConsumer({url:destiny.baseUrl+"broadcasts.json",polling:600,ifModified:true,start:true,ui:"#broadcasts",success:function(data,textStatus){if(textStatus=="notmodified"){return}var broadcasts=$("#broadcasts"),ui=broadcasts.find(".thumbnails:first").empty();ui.removeClass("thumbnails-loading");if(data!=null&&typeof data.videos!=undefined){for(var i in data.videos){var time=moment(data.videos[i].recorded_at).fromNow();ui.append('<li><div class="thumbnail" data-placement="bottom" rel="tooltip" title="'+time+'"><a href="'+data.videos[i].url+'"><img alt="'+time+'" src="'+destiny.cdn+'/web/img/320x240.gif" data-src="'+data.videos[i].preview+'"></a></div></li>')}ui.loadImages();ui.find('[data-toggle="tooltip"]').tooltip()}}});new DestinyFeedConsumer({url:destiny.baseUrl+"stream.json",polling:30,ifModified:true,start:false,ui:"#twitchpanel",success:function(data,textStatus){if(textStatus=="notmodified"){return}var ui=$("#twitchpanel .panelheader .game");if(data!=null&&data.stream!=null){ui.html('<i class="icon-time icon-white subtle"></i> <span>Started '+moment(data.stream.channel.updated_at).fromNow()+"</span>"+((data.stream.channel.delay>0)?" - "+parseInt((data.stream.channel.delay/60))+"m delay":"")).show();$("#twitchpanel").removeClass("offline").addClass("online")}else{try{ui.html('<i class="icon-time icon-white subtle"></i> <span>Last broadcast ended '+moment(data.lastbroadcast).fromNow()+"</span>").show()}catch(e){ui.html('<i class="icon-time icon-white subtle"></i> <span>Broadcast has ended</span>').show()}$("#twitchpanel").removeClass("online").addClass("offline")}}});var pads=$(".private-ads .private-ad"),adRotateIndex=pads.length-1;setInterval(function(){$(pads[adRotateIndex]).fadeOut(500,function(){$(this).hide().removeClass("active")});if(adRotateIndex<pads.length-1){adRotateIndex++}else{adRotateIndex=0}$(pads[adRotateIndex]).hide().addClass("active").fadeIn(500)},8*1000);var gad=$("#google-ad");setTimeout(function(){if(gad.css("display")=="none"||parseInt(gad.height())<=0){gad.before('<div id="adblocker-message"><a>Add blocker</a><p>Please consider turning adblocker off for this website.</p></div>')}},8000);$('.nav a[rel="signout"]').click(function(){if(confirm("Are you sure?")){window.location.href=destiny.baseUrl+"Logout"}});(function(){var timezone=moment().format("ZZ"),calendarFrame=$("#scheduleCalendar iframe"),tzNote=$("#scheduleCalendarTimezone"),timezoneSelect=tzNote.find("select"),timezoneBtn=tzNote.find("button.change-timezone"),timezoneLbl=tzNote.find("span.timezone");var loadGoogleCalendar=function(){calendarFrame.attr("src",calendarFrame.data("src")+"&ctz="+encodeURIComponent(timezone));timezoneLbl.html(timezone)};timezoneBtn.on("click",function(){$("#scheduleCalendarForm").toggle("hide")});timezoneSelect.on("change",function(){timezone=timezoneSelect.val();loadGoogleCalendar();return false});loadGoogleCalendar()})();$("body#bigscreen").each(function(){var offset=81,pc=$(".page-content");var _resize=function(){var bh=$("body").height();pc.height(((bh<550)?550:bh)-offset);pc.find("#chat-panel .twitch-element").height(pc.height()-20);if(document.fullscreen||document.mozFullScreen||document.webkitIsFullScreen){pc.find("#twitch-stream-wrap .twitch-element").height("100%")}else{pc.find("#twitch-stream-wrap .twitch-element").height(pc.height()-20-30)}};$(window).on("resize",_resize);_resize();new DestinyFeedConsumer({url:destiny.baseUrl+"stream.json",polling:30,ui:"#twitch-stream-wrap .panelheader .game",ifModified:true,success:function(data,textStatus){if(textStatus=="notmodified"){return}var ui=$("#twitch-stream-wrap .panelheader .game");if(data!=null&&data.stream!=null){ui.html('<i class="icon-time icon-white subtle"></i> <span>Started '+moment(data.stream.channel.updated_at).fromNow()+"</span>"+((data.stream.channel.delay>0)?" - "+parseInt((data.stream.channel.delay/60))+"m delay":"")).show();return}try{ui.html('<i class="icon-time icon-white subtle"></i> <span>Last broadcast ended '+moment(data.lastbroadcast).fromNow()+"</span>").show()}catch(e){ui.html('<i class="icon-time icon-white subtle"></i> <span>Broadcast has ended</span>').show()}}})});$("form .refresh-captcha").click(function(){var img=$(this).prev(),src=img.attr("src");img.removeAttr("str").attr("src",src);return false});$(".collapse").collapse();if(location.hash!==""){$('a[href="'+location.hash+'"]').tab("show")}$("body").each(function(){$('.navbar a[rel="'+$("body").attr("id")+'"]').closest("li").addClass("active");$('.navbar a[rel="'+$("body").attr("class")+'"]').closest("li").addClass("active")});$(this).loadImages();$(this).find('[data-toggle="tooltip"]').tooltip()});(function(){var applyMomentToElement=function(e){var ui=$(e),datetime=ui.data("datetime")||ui.attr("datetime")||ui.text(),format=ui.data("format")||"MMMM Do, h:mm:ss a";if(ui.data("moment-fromnow")){ui.addClass("moment-update");ui.html(moment(datetime).fromNow())}else{ui.html(moment(datetime).format(format))}ui.data("datetime",datetime).addClass("moment-set")};window.setInterval(function(){$("time.moment-update").each(function(){applyMomentToElement(this)})},30000);$('time[data-moment="true"]:not(.moment-set)').each(function(){applyMomentToElement(this)})})();(function(){window.setInterval(function(){$.ajax({url:"/ping",method:"get"})},10*60*1000)})();(function(){$.cookie.json=true;$(".alert .close.persist").each(function(){var parent=$(this).parent(".alert"),id=parent.attr("id");if(!id){return}id="alert-dismissed-"+id;$(this).click(function(){$.cookie(id,true,{expires:365})});if($.cookie(id)){parent.remove()}})})();